<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Sunyata</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blog.omitol.com/"/>
  <updated>2017-11-09T02:19:03.758Z</updated>
  <id>http://blog.omitol.com/</id>
  
  <author>
    <name>Wayde</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Tmux 简明指南</title>
    <link href="http://blog.omitol.com/2017/11/03/Tmux-Guide/"/>
    <id>http://blog.omitol.com/2017/11/03/Tmux-Guide/</id>
    <published>2017-11-03T04:26:51.000Z</published>
    <updated>2017-11-09T02:19:03.758Z</updated>
    
    <content type="html"><![CDATA[<p>Tmux 做为一利器，很早就知道了，但是一直没有搞明白其使用场景，甚至一直在以错误的方式使用。现今花点时间搞明白它。</p><p>首先就是使用场景的问题，至于具体的命令以后在慢慢记忆。</p><a id="more"></a><h2 id="使用场景"><a class="header-anchor" href="#使用场景">¶ </a>使用场景</h2><ol><li>在远程机器上安装和使用 tmux。一般使用 SSH 登陆到远程机器上后，若 SSH 断开后，在重新登陆，但是原先的窗口中的输出啊什么的就看不到了。若 SSH 登陆后，使用 tmux 命令开启一个会话，就算 SSH 断开了，你在重新登陆后，直接 attach 到原先的会话，就回到了原先的工作现场。而且在会话的窗口中可以使用 tmux 的快捷键开启多个面板，不需要在来一个 SSH 连接过去了。在 SSH 登陆的时候，使用 <code>ssh user@host &quot;command&quot;</code> 或 <code>ssh user@host -- command</code>，直接在远程机器上执行命令，如 tmux。</li><li>在本地机器上安装使用 tmux。在本地使用的话，可以方便的分屏，在会话和终端中切换，减少窗口数量等。这些iTerm2 就可以啦，一般还是在远程机器上使用。不过 detach 后，倒是可以变相的隐藏窗口…</li></ol><h2 id="tmux-的使用"><a class="header-anchor" href="#tmux-的使用">¶ </a>Tmux 的使用</h2><p>Ctrl + b，然后 d，就会从当前会话中分离，回到原先终端。在原先终端中 <code>tmux attach</code>，就可以来到原先的会话。</p><p>在 tmux 的会话中，按下 Ctrl + b 后是激活控制台，输入 ? 可以显示控制台命令帮助。</p><p>如果有多个会话，可以使用 <code>tmux ls</code> 查看，然后 <code>tmux attach -t sessionname</code> 进入到这个会话。</p><p>命令可以查看这个 <a href="https://gist.github.com/MohamedAlaa/2961058" target="_blank" rel="external">CheatSheet</a></p><h2 id="mac-上和-iterm2-的集成"><a class="header-anchor" href="#mac-上和-iterm2-的集成">¶ </a>Mac 上和 iTerm2 的集成</h2><p>如果本地机器使用的是 iTerm2，在 SSH 远程连接中使用 <code>tmux -CC</code> 命令，一个新的 tmux 会话就会被创建，并会开启一个新的窗口，而且 iTerm2 会接管 tmux 的功能，如分屏，就无需使用 tmux 的命令来进行了，可直接在这个新的窗口中使用 iTerm2 的快捷键，还有如历史查找等快捷键，也没必要对远程机器进行单独配置这些了。关闭某个面板时，选择 Hide，就可以使用 <code>tmux -CC attach</code> 命令来 attach 了。这个依然是使用场景1。</p><p>在 iTerm2 的 <code>Preferences &gt; general</code> 中有一项 <code>tmux Integration</code>，可以对集成的 tmux 进行一些设置，如打开新窗口做为本地 tab，执行 <code>tmux -CC attach</code> 后，隐藏本窗口等。</p><p>使用 mosh 替代 ssh，mosh 会自动断开重连，需要在两端都安装。不过若使用 mosh 的连接，使用 <code>-CC</code> 参数无反应。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Tmux 做为一利器，很早就知道了，但是一直没有搞明白其使用场景，甚至一直在以错误的方式使用。现今花点时间搞明白它。&lt;/p&gt;
&lt;p&gt;首先就是使用场景的问题，至于具体的命令以后在慢慢记忆。&lt;/p&gt;
    
    </summary>
    
      <category term="Tools" scheme="http://blog.omitol.com/categories/Tools/"/>
    
    
      <category term="tmux" scheme="http://blog.omitol.com/tags/tmux/"/>
    
  </entry>
  
  <entry>
    <title>JVM 之多态的实现</title>
    <link href="http://blog.omitol.com/2017/10/15/JVM-Polymorphism/"/>
    <id>http://blog.omitol.com/2017/10/15/JVM-Polymorphism/</id>
    <published>2017-10-15T03:31:25.000Z</published>
    <updated>2017-10-15T11:40:44.732Z</updated>
    
    <content type="html"><![CDATA[<p>这部分的笔记在国庆假期前就整理好了，然后说再加工一下，放到 blog 上，毕竟笔记只是适合自己看，没有很强的逻辑性。但每个假期回来后，都会患上一定的假期综合征，总需要几天收收心。就一直拖到现在，简直无可救药。</p><p>OOP 的三大特征：封装、继承、多态。以前记忆的时候都是不分先后，随便记忆的，加深理解后才知道这三个特性是一个递进的过程。最后的多态是在继承的基础之上的。</p><p>这里先从 JVM 方法调用说起，最后在得出多态的概念。</p><a id="more"></a><h2 id="方法调用指令"><a class="header-anchor" href="#方法调用指令">¶ </a>方法调用指令</h2><p>在 JVM 中有四个主要的方法调用指令：</p><ul><li>invokestatic</li><li>invokespecial</li><li>invokevirtual</li><li>invokeinterface</li></ul><p>在 Class 文件中，这些方法调用指令后面跟着的是要调用方法的符号引用。这些符号引用最终都要在类加载阶段或运行期转化为直接引用。</p><p>其中 invokestatic 和 invokespecial 这两个指令调用的方法称为解析调用，是一个静态过程， 在编译期间就完全确定。要调用方法的符号引用在运行时常量池中已经在类加载的解析阶段被解析为了方法的直接引用，就不需要在运行期去方法表中查找了。这些方法有静态方法、私有方法、实例构造器，称为<strong>非虚方法</strong>。</p><p>其中 invokestatic 用于调用静态方法，invokespecial 用于调用私用方法和实例构造器。此外虽然被 final 修饰的方法是使用 invokesvirtual 来调用的，但由于 final 方法无法被子类覆写，只存在唯一版本，所以也是一种非虚方法。这也是这些方法无法被继承或覆写在 JVM 的体现。</p><p>而 invokesvirtual 和 invokeinterface 这两个指令调用的方法称为分派调用，是在运行期才能确定正确的目标方法，得到直接引用。而分派调用又分为静态分派和动态分派。</p><h2 id="分派调用"><a class="header-anchor" href="#分派调用">¶ </a>分派调用</h2><p>分派都是通过方法的符号引用去运行时常量池中去查找得到方法所属类型（即调用该方法的引用变量所属类型，是静态类型）及方法名和描述符，然后根据方法名和描述符去所属类型的方法表中查找确定该方法的目标版本，进而得到方法的直接引用。</p><h3 id="静态分派"><a class="header-anchor" href="#静态分派">¶ </a>静态分派</h3><p>所有依赖静态类型来定位方法执行版本的分派动作称为静态分派。</p><p>在 Java 中的体现就是方法重载，在编译阶段，编译器会根据参数的静态类型决定使用哪个重载版本，完全发生在编译阶段，因此确定静态分派的动作实际上不是由虚拟机来执行的。只是在运行期间去静态类型的方法表中查找该方法，从而得到该方法的直接引用。</p><h3 id="动态分派"><a class="header-anchor" href="#动态分派">¶ </a>动态分派</h3><p>相对于静态分派，动态分派是在运行期根据实际类型来确定方法执行版本的分派过程称为动态分派。</p><p>在 Java 中的体现就是方法的覆写。因为实际类型在运行期间可随着程序变化，因此只能在在运行期间才能确定一个对象的实际类型是什么，编译时编译器并不知道，只知道静态类型是什么。那就需要动态的分派目标方法执行版本。这个过程就是重写的本质</p><p>但是针对 invokevirtual 和 invokeinterface 两个指令，动态分派的具体过程是不同的：</p><ul><li>invokevirtual，实例调用，调用对象的实例方法。动态的分派目标方法执行版本是先在静态类型方法表中找到目标方法并得到偏移量，根据栈帧中对象的引用得到这个对象，在从对象中指向方法区类信息和运行时常量池的引用得到对象的实际类型的类信息，然后在得到的类信息方法表相同偏移量的位置查找目标方法</li><li>invokeinterface, 接口方法调用，在运行时再确定一个实现此接口的对象。因为一个类可以实现多个接口，相当于多继承。所以就不能按照偏移量去实现类的方法表中查找了，只能通过搜索完整的方法表。</li></ul><p>不管是动态分派还是静态分派，我们发现都离不开一个关键的东西<strong>方法表</strong>，最终都是通过方法表进行索引从而得到方法的直接引用。因此方法表是实现动态分派的一个关键。</p><h2 id="方法表"><a class="header-anchor" href="#方法表">¶ </a>方法表</h2><p>JVM 在完成类加载后，会将这个 class 文件二进制字节流转化为虚拟机所需格式存储在方法区中，称为类信息，类信息就是类文件在运行时的数据结构，包含了该类中所有定义的信息。</p><p>类信息中包含有一个方法表，方法表中包括从父类（一直到 Object 类）继承的所有实例方法（不包含私有方法，因为私有方法不能继承）以及自身覆写的方法的直接引用，这些直接引用指向类信息中相应的方法代码。</p><p>如果是本类的方法或者是覆写了父类的方法，则指向的是本类类信息中相应的方法代码；如果是父类的方法，则指向的是父类类信息中的方法代码。这样通过方法表中方法的引用就可以访问到该类到根类的所有实例方法。</p><p>方法表示 JVM 用来提高搜索查找目标方法性能的一个实现。invokevirtual 执行时用到的方法表是虚方发；invokeinterface 用到的方法表是接口方法表。为了程序上实现的方便，具有相同签名的方法，在父类、子类的虚方法表中都具有一样的索引号，因此才可直接使用偏移量在实际类型的方法表中进行查找。</p><h2 id="多态"><a class="header-anchor" href="#多态">¶ </a>多态</h2><p>那么什么是多态呢，一般的书籍都是把多态分为两种：</p><ul><li>编译时多态，通过方法的重载体现，是静态分派</li><li>运行时多态，通过方法的覆写体现，是动态分派</li></ul><p>因为重载是静态分派，因此也可以说重载不算是多态的一个体现，但并不妨碍我们的理解。</p><p>多态还可以从不同的角度进行定义，如在语法上是子类继承父类并覆写了父类的方法，父类引用指向子类对象。在 OOP 里是 Java 引入了多态性的概念是为了弥补因为单继承而带来的一些不足，如接口也是在一定程度上为了可以使用多继承。</p><p>另外重载和覆写说的都是方法，只有类中的方法才有多态的概念，类中的成员变量和内部类并没有此概念。静态方法也没有多态的概念，和成员变量取值与父类还是子类一样，都是由引用变量的静态类型决定的。也因此可以说静态方法并不能被覆写。</p><h2 id="参考"><a class="header-anchor" href="#参考">¶ </a>参考</h2><p>内容主要来自 《深入理解 Java 虚拟机》第八章。都是自己理解后总结的，难免有错误之处，以后慢慢修正。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这部分的笔记在国庆假期前就整理好了，然后说再加工一下，放到 blog 上，毕竟笔记只是适合自己看，没有很强的逻辑性。但每个假期回来后，都会患上一定的假期综合征，总需要几天收收心。就一直拖到现在，简直无可救药。&lt;/p&gt;
&lt;p&gt;OOP 的三大特征：封装、继承、多态。以前记忆的时候都是不分先后，随便记忆的，加深理解后才知道这三个特性是一个递进的过程。最后的多态是在继承的基础之上的。&lt;/p&gt;
&lt;p&gt;这里先从 JVM 方法调用说起，最后在得出多态的概念。&lt;/p&gt;
    
    </summary>
    
      <category term="java" scheme="http://blog.omitol.com/categories/java/"/>
    
    
      <category term="JVM" scheme="http://blog.omitol.com/tags/JVM/"/>
    
      <category term="多态" scheme="http://blog.omitol.com/tags/%E5%A4%9A%E6%80%81/"/>
    
  </entry>
  
  <entry>
    <title>JVM 之常量池</title>
    <link href="http://blog.omitol.com/2017/09/30/JVM-CP/"/>
    <id>http://blog.omitol.com/2017/09/30/JVM-CP/</id>
    <published>2017-09-30T07:53:41.000Z</published>
    <updated>2017-09-30T16:07:45.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近在看周志明的《深入理解 Java 虚拟机》这本书，不得说，学习 JVM 对更深层次理解 Java 有很大的帮助，两者互相印证。像打通了任督二脉一般，对 OOP 和 语法这块为什么要这么设计，语法为什么要这么写豁然开朗，融汇贯通后也更便于记忆这些知识点。</p><p>文章大多摘自自己的 Wiki <a href="https://github.com/HackerOO7/hackeroo7.github.com/wiki/Java-Basics" target="_blank" rel="external">JavaBasics</a>，都是对知识点的总结，加上自己的理解后一条条写下的。难免有很多理解错误的地方，自己前前后后也纠正了不少，也是一个学习的过程。</p><p>关于常量池这块，本来就知道一个字符串常量池，可是看了 JVM 后，又冒出了好几个常量池，顿时懵逼了。看了大量资料，理解后总结出了这么点知识。</p><a id="more"></a><h2 id="常量池的划分"><a class="header-anchor" href="#常量池的划分">¶ </a>常量池的划分</h2><ul><li>Class 文件常量池</li><li>运行时常量池</li><li>字符串常量池</li></ul><h3 id="class-文件常量池"><a class="header-anchor" href="#class-文件常量池">¶ </a>Class 文件常量池</h3><p>Class 文件常量池指的是编译生成的 class 字节码文件，其结构中有一项是常量池（Constant Pool Table），用于存放编译期生成的各种<strong>字面量</strong>和<strong>符号引用</strong>，这部分内容将在类加载后进入方法区的运行时常量池中存放。</p><p>什么是字面量和符号引用呢，为了理解这两个概念，只能啰嗦的写了。</p><ul><li>这里的字面量是指字符串字面量和声明为 final 的（基本数据类型）常量值，这些字符串字面量除了类中所有双引号括起来的字符串(包括方法体内的)，还包括所有用到的类名、方法的名字和这些类与方法的字符串描述、字段(成员变量)的名称和描述符；声明为final的常量值指的是成员变量，不包含本地变量，本地变量是属于方法的。这些都在常量池的 UTF-8 表中(逻辑上的划分)</li><li>符号引用，就是指指向 UTF-8 表中向这些字面量的引用，包括类和接口的全限定名(包括包路径的完整名)、字段的名称和描述符、方法的名称和描述符。只不过是以一组符号来描述所引用的目标，和内存并无关，所以称为符号引用，直接指向内存中某一地址的引用称为直接引用</li></ul><h3 id="运行时常量池"><a class="header-anchor" href="#运行时常量池">¶ </a>运行时常量池</h3><p>运行时常量池是方法区的一部分，是一块内存区域。Class 文件常量池将在类加载后进入方法区的运行时常量池中存放。</p><p><strong>一个类加载到 JVM 中后对应一个运行时常量池</strong>，运行时常量池相对于 Class 文件常量池来说具备动态性，Class 文件常量只是一个静态存储结构，里面的引用都是符号引用。而运行时常量池可以在运行期间将符号引用解析为直接引用。</p><p>可以说运行时常量池就是用来索引和查找字段和方法名称和描述符的。给定任意一个方法或字段的索引，通过这个索引最终可得到该方法或字段所属的类型信息和名称及描述符信息，这涉及到方法的调用和字段获取。</p><h3 id="字符串常量池"><a class="header-anchor" href="#字符串常量池">¶ </a>字符串常量池</h3><ul><li>在 jdk1.6（含）之前也是方法区的一部分，并且其中存放的是字符串的实例</li><li>在 jdk1.7（含）之后，是在堆内存之中，存储的是字符串对象的引用，字符串实例是在堆中</li><li>jdk1.8 已移除永久代，字符串常量池是在本地内存当中，存储的也只是引用</li></ul><p><strong>字符串常量池是全局</strong>的，JVM 中独此一份，因此也称为全局字符串常量池。</p><p>运行时常量池中的字符串字面量若是成员的，则在类的加载初始化阶段就使用到了字符串常量池；若是本地的，则在使用到的时候（执行此代码时）才会使用到字符串常量池。</p><p>其实，“使用常量池”对应的字节码是一个 <code>ldc</code> 指令，在给 String 类型的引用赋值的时候会先执行这个指令，看常量池中是否存在这个字符串对象的引用，若有就直接返回这个引用，若没有，就在堆里创建这个字符串对象并在字符串常量池中记录下这个引用（jdk1.7)。String 类的 <code>intern()</code> 方法还可在运行期间把字符串放到字符串常量池中。</p><p>JVM 中除了字符串常量池，8种基本数据类型中除了两种浮点类型剩余的6种基本数据类型的包装类，都使用了缓冲池技术，但是 Byte、Short、Integer、Long、Character 这5种整型的包装类也只是在对应值在 [-128,127] 时才会使用缓冲池，超出此范围仍然会去创建新的对象。</p><h2 id="总结"><a class="header-anchor" href="#总结">¶ </a>总结</h2><p>理解了这部分后，后面才能更容易的理解 JVM 中方法的调用，多态的实现等。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近在看周志明的《深入理解 Java 虚拟机》这本书，不得说，学习 JVM 对更深层次理解 Java 有很大的帮助，两者互相印证。像打通了任督二脉一般，对 OOP 和 语法这块为什么要这么设计，语法为什么要这么写豁然开朗，融汇贯通后也更便于记忆这些知识点。&lt;/p&gt;
&lt;p&gt;文章大多摘自自己的 Wiki &lt;a href=&quot;https://github.com/HackerOO7/hackeroo7.github.com/wiki/Java-Basics&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;JavaBasics&lt;/a&gt;，都是对知识点的总结，加上自己的理解后一条条写下的。难免有很多理解错误的地方，自己前前后后也纠正了不少，也是一个学习的过程。&lt;/p&gt;
&lt;p&gt;关于常量池这块，本来就知道一个字符串常量池，可是看了 JVM 后，又冒出了好几个常量池，顿时懵逼了。看了大量资料，理解后总结出了这么点知识。&lt;/p&gt;
    
    </summary>
    
      <category term="java" scheme="http://blog.omitol.com/categories/java/"/>
    
    
      <category term="JVM" scheme="http://blog.omitol.com/tags/JVM/"/>
    
      <category term="常量池" scheme="http://blog.omitol.com/tags/%E5%B8%B8%E9%87%8F%E6%B1%A0/"/>
    
  </entry>
  
  <entry>
    <title>Android 安全引导机制分析和绕过测试</title>
    <link href="http://blog.omitol.com/2017/09/30/Bypass-QCOM-Secure-Boot/"/>
    <id>http://blog.omitol.com/2017/09/30/Bypass-QCOM-Secure-Boot/</id>
    <published>2017-09-30T04:44:31.000Z</published>
    <updated>2017-09-30T09:12:06.000Z</updated>
    
    <content type="html"><![CDATA[<p>上半年为了学位写了一篇论文，今天把它转成了 markdown 格式，便于分享。全文在我的 <a href="https://github.com/HackerOO7/hackeroo7.github.com/wiki/Bypass-QCOM-Secure-Boot" target="_blank" rel="external">Wiki里</a>，算是全文吧，去除了很多论文必须的废话。并把其中的干货拿出来放到这里。</p><p>文章对高通的安全引导机制进行了简单分析，并在小米一款机器上综合漏洞成功绕过了其安全引导机制,达到自由修改系统分区的目的。</p><a id="more"></a><h2 id="android安全引导流程和组成"><a class="header-anchor" href="#android安全引导流程和组成">¶ </a>Android安全引导流程和组成</h2><h3 id="android安全引导流程"><a class="header-anchor" href="#android安全引导流程">¶ </a>Android安全引导流程</h3><p>一台 Android 设备是由硬件和软件组成，当按下开机键时系统从硬件到软件，在到最后进入 Android 系统，是一个完成的引导过程。以高通为例，在一个常规的引导过程中，CPU 引导芯片代码 PBL（Primary Boot Loader，类似于 x86 的 BIOS，有时也被成为 BootROM）从预定义的地方（固化在 ROM）开始执行，PBL由高通做好后烧写在芯片中，不可更改，是 RoT（Root of Trust，信任根）。使用烧录在fuse中的根公钥校验并加载引导程序 SBL1（Secondary Boot Loader），跳转到 sbl1 执行，SBL1 加载校验 APPSBL（aboot），最后 APPSBL 加载校验 boot 分区<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>。内核启动后，会通过内核中的 dm-verity<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup> 功能模块校验系统分区的完整性。这样就完成了整个系统的安全引导。整个流程如图所示<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>：</p><p><img src="/media/image2.png" alt="secureboot_flow" title="安全引导流程"></p><p>目前 Android 一个完整的校验过程，分为两部分：</p><ol><li><p>一分部是官方的 verified boot，由内核中的 dm-verity 来确保 system 分区没有经过被篡改</p></li><li><p>另一部分是针对于不同设备的引导加载程序的安全引导来验证最终 boot 镜像的完整性。这两部分共同建立了一个从 bootloader 到系统镜像的信任校验链</p></li></ol><h3 id="android安全引导组成"><a class="header-anchor" href="#android安全引导组成">¶ </a>Android安全引导组成</h3><h4 id="引导加载程序的安全引导"><a class="header-anchor" href="#引导加载程序的安全引导">¶ </a>引导加载程序的安全引导</h4><p>这个过程是一个安全认证校验链，都是由上一阶段的程序加载校验下一阶段的要执行的程序，通过签名校验机制，来确保系统不被经过任何形式的篡改，只执行制造商的固件。此过程是特定于设备的，通常通过使用不可更改的特定于硬件的密钥来实现被“烧录”（写入只写存储器）到设备中。该密钥用于验证每级的引导加载程序到最终boot镜像的完整性。</p><p>高通的 bootloader 是开源项目，在 Android 代码树的 <code>bootable/bootloader/lk</code> 下可以看到它的代码。是针对特定的主板与芯片编写的，并不是Android操作系统的一部分。由于 SBL 代码是闭源代码，分析起来是一个复杂的过程。论文在分析研究引导加载程序的安全引导过程中只从 APPSBL 开始进行分析。</p><p>Bootloader 是 OEM 厂商或者运营商加锁和限制的地方。当 bootloader 上锁后就不允许在非解锁状态下对手机固件进行修改或者刷第三方系统。这些限制取决于 OEM 和运营商的具体决策，可能会有所不同，但普遍都会采用密码学的签名校验机制来阻止设备被刷机或者执行未经合法签名的代码。如果用户想要刷机就需要先对 bootloader 进行解锁。现 OEM 都会采用专门的机制，比如需向官方申请解锁码，申请通过后得到解锁码才可以解锁设备。设备解锁后 bootloader 将不再对 boot 和 recovery 分区进行签名校验，也就是不在进行安全引导，允许进行刷机和清除用户数据等操作。</p><p>后面的章节还将会针对高通的 LK 的签名和校验<br>机制进行解剖分析，研究具体的安全保护措施，分析存在的安全缺陷和隐患。</p><h4 id="verified-boot"><a class="header-anchor" href="#verified-boot">¶ </a>Verified Boot</h4><p>从版本 4.4 起，Android 支持使用 Linux 的 Device-Mapper<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup> 框架中的 dm-verity 功能进行验证启动。Dm-verity 是为块完整性检查而设计开发，使用加密散列树提供块设备的透明完整性检查。它可以验证每个设备块在从磁盘读取时的完整性，如果块检出，则读取成功;<br>如果没有，读取会产生 I/O 错误，就好像块被实际损坏了一样。在 Android 中用来保护系统重要分区如 system 分区或 vendor 分区的完整性。系统分区被挂载为只读模式，不再允许被挂载为读写模式。校验系统分区时使用的密钥在 boot 镜像的 ramdisk 中。</p><p>论文后面的章节还将会继续分析 Verified Boot 在 Android 上的具体实现，研究存在的安全缺陷和隐患。</p><h2 id="android安全引导机制及缺陷分析"><a class="header-anchor" href="#android安全引导机制及缺陷分析">¶ </a>Android安全引导机制及缺陷分析</h2><h3 id="引导加载程序引导机制分析"><a class="header-anchor" href="#引导加载程序引导机制分析">¶ </a>引导加载程序引导机制分析</h3><h4 id="user-keystore校验漏洞挖掘"><a class="header-anchor" href="#user-keystore校验漏洞挖掘">¶ </a>user keystore校验漏洞挖掘</h4><p>Bootloader 序是一种专门的，特定于硬件的程序，当设备首次通电（ARM 设备复位时）执行。其目的是初始化设备硬件，提供最小的设备配置接口，然后找到并启动操作系统。引导设备通常需要经历不同的阶段，这涉及每个阶段的单独的引导加载程序，本文只分析 APPSBL（aboot）加载引导程序。Android 引导加载程序通常是专有的，特定于芯片 SoC 的系统。设备和 SoC 制造商在其引导加载程序中提供不同的功能和级别的保护。</p><p>在整个校验链中由aboot来提供验证 boot.img 的完整性，其开源代码 LK 可在 Code Aurora Forum 下载。在 LK 中有两个可用于校验的不同的密钥：</p><ul><li><p>一个是 <code>oem_keystore</code>，被编译到 aboot 中，定义在 <code>platform/msm_shared/include/oem_keystore.h</code></p></li><li><p>一个是 <code>user_keystore</code> 存储在 keystore 分区中</p></li></ul><p>引导过程中始终尝试使用 OEM keystore 来验证 boot.img 和 recovery.img。但在 keystore 分区不为空的时候，会使用 OEM keystore 对其签名进行验证，如果验证通过，将从里面读取 <code>user_keystore</code>，然会用其验证 boot.img 和 recovery.img。</p><p><code>user_keystore</code> 包含了用于验证的 RSA 公钥。以 CAF 代码 <code>LA.BR.1.3.2_rb3.14</code>分支为例，整个基本函数和逻辑执行如图所示：</p><p><img src="/media/image3.png" alt="boot_verify_flow" title="bootimage 验证流程"></p><p>最终调用的 <code>verify_image_with_sig()</code> 采用的是 <code>user_keystore</code>中的公钥进行校验。而 <code>user_keystore</code> 的值由 <code>boot_verifier_init</code> 调用 <code>read_oem_keystore</code>，将<br><code>oem_keystore</code> 赋值 <code>user_keystore</code>。接着对 keystore 分区进行验证，如果验证通过，则将分区中的数据赋值 <code>user_keystore</code>。这样就完成了对 user<br>keystore 的利用。</p><p>但是 <code>read_user_keystor()</code> 方法中调用 <code>verify_keystore</code> 验证 user keystore 时，在 <code>if-else</code> 判断中的 385 行因缺少花括号，导致无论验证成功与否，都会 <code>user_keystore</code> 进行赋值。具体代码如图所示：</p><p><img src="/media/image4.png" alt="issue_code" title="问题代码"></p><p>这样就造成了一个明显的安全漏洞，user keystore 不用经过 OEM 的签名也可以用于校验 boot 或 recovery 镜像。我们只需要自己签名生成 keystore.img 通过其它漏洞写入手机就可以绕过安全引导机制。</p><h4 id="解锁标记位的保护分析"><a class="header-anchor" href="#解锁标记位的保护分析">¶ </a>解锁标记位的保护分析</h4><p>在高通的分区表中，有一个名为 devinfo 的分区，大小 1024K。在 <code>app/aboot/devinfo.h</code> 中定义了其数据结构，包括了 <code>is_unlocked</code> 解锁状态标记位；<code>is_tampered</code> 篡改标记位等。通过 <code>fastboot oem device-info</code> 命令可以获取相关信息。</p><p>在 LK 启动时，通 <code>aboot\_init()-&gt;read_device_info(&amp;device)-&gt;read_device_info_mmc()</code> 读取，若 <code>is_unlock</code> 为 true，就跳过校验，允许执行 flash 命令等。使用 <code>fastboot oem unlock</code> 命令后，会通过 <code>write_device_info_mmc(&amp;device)</code> 对 devinfo 分区的标记位进行操作。</p><p>高通源代码中并为对该标记位进行加密签名等保护，直接修改标记位就可以使用对手机的解锁。但是在 OEM 的实现中，大多都会对该分区进行保护，修改分区名和使用加密签名等手段，保证分区不被非法篡改。</p><p>但 Android 碎片化的存在，厂商技术的参差不齐，依然有很多设备未对该部分进行修改，留下了安全漏洞。</p><h4 id="高通下载模式分析"><a class="header-anchor" href="#高通下载模式分析">¶ </a>高通下载模式分析</h4><p>高通有着自己的下载协议，一般在设备生产的时候通过该协议烧录固件。在 lk 代码 <code>aboot_init</code> 中，通过监控按键等操作可以选择到进入到不同的模式，如 recovery 或<br>fastboot 模式等。代码中默认当同时按下音量上下键时，则进入到 DLOAD 模式，也就是下载模式。然后通过高通专有的 sahara 或 firehose 协议工具进行固件的下载更新<sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup>。</p><p>同样在 <code>kernel/drivers/power/reset/msm-poweroff.c</code> 中相关代码由宏 <code>CONFIG_MSM_DLOAD_MOD</code> 控制，可开启或关闭是否可以通过  <code>adb reboot edl/dload</code> 命令重启进入到下载模式。</p><p>高通的升级工具及协议在下载的过程中，并不会对固件进行任何的校验，如果下载了错误或损坏的固件，则直接会让设备变砖。但是，厂商为方便开发、生产、售后等需求，并不会完全关闭掉高通的下载模式，有的会留下隐蔽的接口来进入到该模式。</p><h3 id="android的verified-boot"><a class="header-anchor" href="#android的verified-boot">¶ </a>Android的Verified Boot</h3><h4 id="dm-verity概述"><a class="header-anchor" href="#dm-verity概述">¶ </a>Dm-verity概述</h4><p>Dm-verity 使用加密散列树提供块设备的透明完整性检查，每个块以 4k 的大小来划分，都有一个 SHA256 的值。树中的每个节点是加密 hash，其中叶节点包含物理数据块的 hash，并且中间节点包含其子节点的 hash。因为根节点中的哈希是基于所有其他节点的值，所以只有根哈希需要被信任才能验证树的其余部分。对任何一个节点块的改动都破坏整个加密 hash。整个哈希树的结构如图所示：</p><p><img src="/media/image5.png" alt="dm-verity_hash-tree" title="哈希树"></p><p>验证时使用包含在 boot 分区中的 RSA 公钥来执行。设备块在运行时通过计算读取的块的哈希值并将其与散列树中的记录值进行比较来检查。如果值不匹配，则读取操作将导致 I/O 错误，指示文件系统已损坏。因为所有的检查都是由内核执行的，所以启动过程需要验证 boot.img 的完整性，以便验证引导工作。</p><p>在 Android 中被校验的分区始终挂载为只读状态，只能在 OTA 块设备升级时才可做更改。其它任何对分区的操作都会破坏分区的完整性，比如 root 等操作。</p><h4 id="在android中的实现方法"><a class="header-anchor" href="#在android中的实现方法">¶ </a>在Android中的实现方法</h4><p>Dm-verity device-mapper 目的最初是为了在 Chrome 操作系统中实现验证启动而开发的，并且已经在 Linux 内核的 3.4 版本中集成。它使用 <code>CONFIG_DM_VERITY</code> 内核配置项来进行开关。</p><p>但 Android 的具体实现方式和 Chrome 有所不同。用于验证的 RSA 公钥在 boot 镜像的 ramdisk 中，文件名是 <code>verity_key</code>，用于验证目标设备的 root<br>hash 签名。被验证的目标分区，有着一个包含了哈希表和它自身签名的元数据块，被附加到镜像的最后。如果要启用对某一分区的校验，需要在 ramdisk 中的 fstab 文件中对特定设备添加 verify 标签<sup class="footnote-ref"><a href="#fn6" id="fnref6">[6]</a></sup>。</p><p>当系统启动过程中，检测到该标签，则会使用 <code>verity_key</code> 公钥加载校验该分区最后附加的元数据。如果签名验证通过，则文件系统管理器解析 dm-verity 映射表，并将其传递给 Linux 设备映射器，设备映射器使用映射表中包含的信息来创建虚拟的 dm-verity 块设备。然后将该虚拟块设备安装在 fstab 中指定的安装点上，代替相应的物理设备。因此，所有读自底层物理设备的数据都会用预先生成的散列树进行透明验证。对设备任何修改或添加文件，甚至将分区重新挂载为读写都会导致完整性验证和 I/O 错误。虚拟设备的挂载如图所示：</p><p><img src="/media/image6.png" alt="dm-verity-virutal-block-device-mounted" title="虚拟设备"></p><p>但是因为具体的实现方式原因，用于校验的 RSA 公钥 <code>verity_key</code>，直接被放在了 ramdisk中。这给了替换该公钥文件进行攻击的可能性。而且对目标设备是否进行校验，也直接用明 verify 签进行判断，这也是一个明显的安全缺陷。</p><h4 id="启用verified-boot"><a class="header-anchor" href="#启用verified-boot">¶ </a>启用Verified Boot</h4><p>在谷歌的官方文档描述中，要完全启用 verified boot，除了要配置整个编译系统开启相关选项，还需要引导加载程序实现相关对boot镜像的完整性校验。上节已经针对高通 SoC 在这块的实现进行了分析研究。</p><p>AOSP 源代码中，开发 key 包括公钥和私钥，它们位 <code>build/target/product/security/</code> 目录。用来给 boot/recovery/system 镜像签名，以及验证 system 分区的真实性元数据块表<sup class="footnote-ref"><a href="#fn7" id="fnref7">[7]</a></sup>。在启用 verified boot 时需要生成自己的公私钥，但某些机型设备依然是使用的默认的密钥，这相当于是导致了密钥的泄露，对设备来说没有任何安全性可言了。</p><h2 id="漏洞利用测试和安全加固"><a class="header-anchor" href="#漏洞利用测试和安全加固">¶ </a>漏洞利用测试和安全加固</h2><h3 id="利用漏洞绕过安全引导"><a class="header-anchor" href="#利用漏洞绕过安全引导">¶ </a>利用漏洞绕过安全引导</h3><h4 id="攻击方法的设计"><a class="header-anchor" href="#攻击方法的设计">¶ </a>攻击方法的设计</h4><p>在上一章中分析了存在安全缺陷和漏洞。利用自签名的 user keystore 和 boot/recovery 镜像，并且在 boot 的 ramdis k中移除对 system 分区的进行校验的 verify 标记。或者替换 ramdisk 中的verity_key，并对 system 镜像进行签名。刷写到手机中，就能实现绕过某些机型的安全引导机制，对设备进行自由修改。</p><p>但是在设备处于 LOCKED 状态时，是无法通过 fastboot 进行刷写操作的。但是 OEM 一般都会预留自己的下载模式，比如三星的 ODIN，联发科的 SP Flashtool。而高通 SoC 则是上一章中分析到的 dload/edl 模式，该模式在固件镜像下载过程中并不做任何的校验，直接能刷写进去。</p><p>本文测试机器是 红米Note3 全网通版，系统的版本为 V7.2.3.0，Android 版本 6.0,内部开发代号 kenzo。Kenzo 在几次的升级后，逐渐关闭了按键进入，<code>adb reboot dload/edl</code> 重启进入下载模式的途经，开启了 dm-verity，来保护手机不被破解和刷机。但是通过IDA<br>Pro逆向分析 aboot 分区中的 emmc_appsboot.mbn 引导加载程序镜像时，发现了 <code>reboot-edl</code>的命令。如图所示：</p><p><img src="/media/image7.png" alt="reboot-edl_ command" title="小米自己添加的命令"></p><p>正如其命名一样，是标准 fastboot 协议是不支持此命令的，为此需要修改 fastboot 源码。fastboot 源代码在 AOSP 源码树  <code>system/core/fastboot</code> 中。分析 fastboot 源码，命令最后是通过 <code>fb_queue_command</code> 发送给 bootloader，修改代码添加对该命令的支持。然后就能成功的重启到 edl 模式。核心代码示例如图所示：</p><p><img src="/media/image8.png" alt="code" title="添加命令支持"></p><h4 id="漏洞利用测试过程"><a class="header-anchor" href="#漏洞利用测试过程">¶ </a>漏洞利用测试过程</h4><p>整个测试过程是为了验证本文对安全引导机制进行分析研究后挖掘出的相关安全漏洞，达到在设备处于 LOCKED 状态时，篡改并修改设备，绕过 Android 安全引导机制。过程如下：</p><ol><li><p>生成自己的公私钥对</p></li><li><p>利用公私钥对生成并签名 keystore.img</p></li><li><p>对 boot.img 重新打包，移除 system 分区 verify flag</p></li><li><p>对 boot.img 进行重新签名</p></li><li><p>使用修改后的 fastboot，执行<code>fastboot reboot-edl</code>进入下载模式</p></li><li><p>使用 emmcdl<sup class="footnote-ref"><a href="#fn8" id="fnref8">[8]</a></sup> 工具分别刷入 keystore.img boot.img</p></li></ol><p>若设备能成功开启，则证明完全绕过了 Android 的安全引导机制。System 分区也不在不挂载为虚拟设备，而是真实的物理设备块。如图所示：</p><p><img src="/media/image9.png" alt="屏幕快照 2017-03-24 20.05.29" title="真实设备的挂载"></p><p>在手机预装行业中，还会对 system 分区镜像进行篡改，然后利用上面的过程也刷写到手机中。同样也可以修改 devinfo 分区的标记位，强制修改手机的状态。这样有了一套对该机型进行刷机预装的方案。</p><h2 id="参考"><a class="header-anchor" href="#参考">¶ </a>参考</h2><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p><a href="https://security.tencent.com/index.php/blog/msg/38" target="_blank" rel="external">Tecent. Android系统典型bootloader分析</a> <a href="#fnref1" class="footnote-backref">↩</a></p></li><li id="fn2" class="footnote-item"><p><a href="https://code.google.com/p/cryptsetup/wiki/DMVerity" target="_blank" rel="external">Milan Broz. dm-verity: device-mapper block integrity checking target</a> <a href="#fnref2" class="footnote-backref">↩</a></p></li><li id="fn3" class="footnote-item"><p><a href="http://bits-please.blogspot.jp/2016/02/unlocking-motorola-bootloader.html" target="_blank" rel="external">laginimaineb. Unlocking the Motorola Bootloader</a> <a href="#fnref3" class="footnote-backref">↩</a></p></li><li id="fn4" class="footnote-item"><p><a href="https://www.sourceware.org/dm/" target="_blank" rel="external">Red Hat Inc. Device-Mapper Resource Page</a> <a href="#fnref4" class="footnote-backref">↩</a></p></li><li id="fn5" class="footnote-item"><p><a href="http://blog.csdn.net/fybon/article/details/37565227" target="_blank" rel="external">CSDN. 高通 MSM8K bootloader 之二：SBL1</a> <a href="#fnref5" class="footnote-backref">↩</a></p></li><li id="fn6" class="footnote-item"><p><a href="http://source.android.com/devices/tech/security/dm-verity.html" target="_blank" rel="external">Google. dm-verity</a> <a href="#fnref6" class="footnote-backref">↩</a></p></li><li id="fn7" class="footnote-item"><p><a href="http://blog.csdn.net/a04081122/article/details/53522705" target="_blank" rel="external">CSDN. QualComm Android boot recovery vertify</a> <a href="#fnref7" class="footnote-backref">↩</a></p></li><li id="fn8" class="footnote-item"><p><a href="https://github.com/binsys/emmcdl" target="_blank" rel="external">Github. emmcdl</a> <a href="#fnref8" class="footnote-backref">↩</a></p></li></ol></section>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;上半年为了学位写了一篇论文，今天把它转成了 markdown 格式，便于分享。全文在我的 &lt;a href=&quot;https://github.com/HackerOO7/hackeroo7.github.com/wiki/Bypass-QCOM-Secure-Boot&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Wiki里&lt;/a&gt;，算是全文吧，去除了很多论文必须的废话。并把其中的干货拿出来放到这里。&lt;/p&gt;
&lt;p&gt;文章对高通的安全引导机制进行了简单分析，并在小米一款机器上综合漏洞成功绕过了其安全引导机制,达到自由修改系统分区的目的。&lt;/p&gt;
    
    </summary>
    
      <category term="Android" scheme="http://blog.omitol.com/categories/Android/"/>
    
    
      <category term="Secure Boot" scheme="http://blog.omitol.com/tags/Secure-Boot/"/>
    
  </entry>
  
  <entry>
    <title>少了一条腿的大蜘蛛</title>
    <link href="http://blog.omitol.com/2017/09/29/Shamballa-hike-photo/"/>
    <id>http://blog.omitol.com/2017/09/29/Shamballa-hike-photo/</id>
    <published>2017-09-29T09:35:17.000Z</published>
    <updated>2017-10-02T06:08:23.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://i.imgur.com/mjfObX6.jpg" alt="尸横遍野"></p><blockquote><p>少了一条腿的大蜘蛛，摄于九月中旬西山香巴拉中途</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;https://i.imgur.com/mjfObX6.jpg&quot; alt=&quot;尸横遍野&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;少了一条腿的大蜘蛛，摄于九月中旬西山香巴拉中途&lt;/p&gt;
&lt;/blockquote&gt;

      
    
    </summary>
    
      <category term="相册" scheme="http://blog.omitol.com/categories/%E7%9B%B8%E5%86%8C/"/>
    
    
      <category term="西山" scheme="http://blog.omitol.com/tags/%E8%A5%BF%E5%B1%B1/"/>
    
      <category term="香巴拉" scheme="http://blog.omitol.com/tags/%E9%A6%99%E5%B7%B4%E6%8B%89/"/>
    
  </entry>
  
  <entry>
    <title>开始使用 Hexo</title>
    <link href="http://blog.omitol.com/2017/09/28/migrate-to-hexo-md/"/>
    <id>http://blog.omitol.com/2017/09/28/migrate-to-hexo-md/</id>
    <published>2017-09-28T03:07:39.000Z</published>
    <updated>2017-09-28T03:32:18.000Z</updated>
    
    <content type="html"><![CDATA[<p>这几天看到一个主题，自己非常中意。</p><p>一看是 Hexo 下的，早前就想切到这个框架下，但拖延症严重，一直未动手。恰好赶上这个时机，自己又闲来无事，遂动手。</p><p>都是些琐碎的配置工作，自己的文章又不多，索性一篇篇的来修改，又把以前没注意的一些排版上的问题给纠正下。主要添加了一个以前没接触过的 leancloud 的统计。</p><a id="more"></a><p>把以前感觉略中二的博客名字也改了，改为 Sunyata, 中文译文 “空性” 倒是和守望先锋里的和尚禅雅塔发音相似，意思也相近。</p><p>不过 Disqus 的评论给丢了，本就不多，有时间就迁移过来。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这几天看到一个主题，自己非常中意。&lt;/p&gt;
&lt;p&gt;一看是 Hexo 下的，早前就想切到这个框架下，但拖延症严重，一直未动手。恰好赶上这个时机，自己又闲来无事，遂动手。&lt;/p&gt;
&lt;p&gt;都是些琐碎的配置工作，自己的文章又不多，索性一篇篇的来修改，又把以前没注意的一些排版上的问题给纠正下。主要添加了一个以前没接触过的 leancloud 的统计。&lt;/p&gt;
    
    </summary>
    
      <category term="记事" scheme="http://blog.omitol.com/categories/%E8%AE%B0%E4%BA%8B/"/>
    
    
      <category term="hexo" scheme="http://blog.omitol.com/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>使用一加3做 WIFI 中继器</title>
    <link href="http://blog.omitol.com/2017/04/18/oneplus3-as-wifi-repeater/"/>
    <id>http://blog.omitol.com/2017/04/18/oneplus3-as-wifi-repeater/</id>
    <published>2017-04-17T16:00:00.000Z</published>
    <updated>2017-09-27T13:20:18.000Z</updated>
    
    <content type="html"><![CDATA[<p>隔壁学校的 wifi 网络不错，但是因为离得远，信号差，只能在窗户边能连得上。买了一个 360 wifi 中继器，但速度掉的厉害，而用手机直接连接网速倒是正常，就想着把手机作为 wifi 中继器。记得自己的第一台 android 手机，中兴 v880 当时是支持 wifi 中继的，一边连着 wifi，一边扩展 wifi 信号，后来才知道那算是中兴特有的。找了一圈，并没有找到这样的 APP，fqrouter2 倒是有这个功能，但是作者已经停止维护，在我手机上直接启动失败。参考 fqrouter2 的文章和脚本终于让 oneplus3 STA+AP 一起工作了。</p><h2 id="使用一加3做-wifi-中继器脚本配置"><a class="header-anchor" href="#使用一加3做-wifi-中继器脚本配置">¶ </a>使用一加3做 wifi 中继器脚本配置</h2><ul><li>ONEPLUS A3000</li><li>系统 cm-13.0, Android 6.0.1</li><li>root 权限</li><li>iw iwlist wpa_cli 等二进制文件</li></ul><a id="more"></a><p>一加3 采用的是<a href="https://www.qualcomm.com/products/vive/chipsets" target="_blank" rel="external">QCA6164A</a> wifi 芯片，支持 802.11ac，最高有 434M 带宽。</p><p>系统本身自带的便携式 WLAN 热点功能，只能分享移动数据的网络，不能够做为一个 wifi repeater，开启时自动关闭 wifi 连接和 wpa_supplicant进程，并开启 hostapd 进程来提供 AP。 但系统支持 <a href="https://developer.android.com/training/connect-devices-wirelessly/wifi-direct.html" target="_blank" rel="external">WIFI Direct</a> 功能，也就是说设备在连接着 wifi 的时，可以开启一个热点，其它设备可以通过这个热点加入到 P2P group 中。但是 WIFI Direct 不支持手动设置密码，连接外网等。</p><p>查看网卡设备信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div></pre></td><td class="code"><pre><div class="line">root@oneplus3:/data/local/tmp # iw phy</div><div class="line">Wiphy phy3</div><div class="line">    max # scan SSIDs: 10</div><div class="line">    max scan IEs length: 500 bytes</div><div class="line">    max # sched scan SSIDs: 0</div><div class="line">    max # match sets: 0</div><div class="line">    Retry short limit: 7</div><div class="line">    Retry long limit: 4</div><div class="line">    Coverage class: 0 (up to 0m)</div><div class="line">    Device supports roaming.</div><div class="line">    Device supports T-DLS.</div><div class="line">    Supported Ciphers:</div><div class="line">        * WEP40 (00-0f-ac:1)</div><div class="line">        * WEP104 (00-0f-ac:5)</div><div class="line">        * TKIP (00-0f-ac:2)</div><div class="line">        * 00-40-96:254</div><div class="line">        * 00-40-96:255</div><div class="line">        * CCMP-128 (00-0f-ac:4)</div><div class="line">        * WPI-SMS4 (00-14-72:1)</div><div class="line">        * CMAC (00-0f-ac:6)</div><div class="line">    Available Antennas: TX 0 RX 0</div><div class="line">    Supported interface modes:</div><div class="line">         * IBSS</div><div class="line">         * managed</div><div class="line">         * AP</div><div class="line">         * P2P-client</div><div class="line">         * P2P-GO</div><div class="line">    Band 1:</div><div class="line">        Capabilities: 0x9072</div><div class="line">            HT20/HT40</div><div class="line">            Static SM Power Save</div><div class="line">            RX Greenfield</div><div class="line">            RX HT20 SGI</div><div class="line">            RX HT40 SGI</div><div class="line">            No RX STBC</div><div class="line">            Max AMSDU length: 3839 bytes</div><div class="line">            DSSS/CCK HT40</div><div class="line">            L-SIG TXOP protection</div><div class="line">        Maximum RX AMPDU length 65535 bytes (exponent: 0x003)</div><div class="line">        Minimum RX AMPDU time spacing: 16 usec (0x07)</div><div class="line">        HT Max RX data rate: 72 Mbps</div><div class="line">        HT TX/RX MCS rate indexes supported: 0-7</div><div class="line">        Bitrates (non-HT):</div><div class="line">            * 1.0 Mbps</div><div class="line">            * 2.0 Mbps</div><div class="line">            * 5.5 Mbps</div><div class="line">            * 11.0 Mbps</div><div class="line">            * 6.0 Mbps</div><div class="line">            * 9.0 Mbps</div><div class="line">            * 12.0 Mbps</div><div class="line">            * 18.0 Mbps</div><div class="line">            * 24.0 Mbps</div><div class="line">            * 36.0 Mbps</div><div class="line">            * 48.0 Mbps</div><div class="line">            * 54.0 Mbps</div><div class="line">        Frequencies:</div><div class="line">            * 2412 MHz [1] (20.0 dBm)</div><div class="line">            * 2417 MHz [2] (20.0 dBm)</div><div class="line">            * 2422 MHz [3] (20.0 dBm)</div><div class="line">            * 2427 MHz [4] (20.0 dBm)</div><div class="line">            * 2432 MHz [5] (20.0 dBm)</div><div class="line">            * 2437 MHz [6] (20.0 dBm)</div><div class="line">            * 2442 MHz [7] (20.0 dBm)</div><div class="line">            * 2447 MHz [8] (20.0 dBm)</div><div class="line">            * 2452 MHz [9] (20.0 dBm)</div><div class="line">            * 2457 MHz [10] (20.0 dBm)</div><div class="line">            * 2462 MHz [11] (20.0 dBm)</div><div class="line">            * 2467 MHz [12] (20.0 dBm)</div><div class="line">            * 2472 MHz [13] (20.0 dBm)</div><div class="line">            * 2484 MHz [14] (disabled)</div><div class="line">    Band 2:</div><div class="line">        Capabilities: 0x9072</div><div class="line">            HT20/HT40</div><div class="line">            Static SM Power Save</div><div class="line">            RX Greenfield</div><div class="line">            RX HT20 SGI</div><div class="line">            RX HT40 SGI</div><div class="line">            No RX STBC</div><div class="line">            Max AMSDU length: 3839 bytes</div><div class="line">            DSSS/CCK HT40</div><div class="line">            L-SIG TXOP protection</div><div class="line">        Maximum RX AMPDU length 65535 bytes (exponent: 0x003)</div><div class="line">        Minimum RX AMPDU time spacing: 16 usec (0x07)</div><div class="line">        HT Max RX data rate: 72 Mbps</div><div class="line">        HT TX/RX MCS rate indexes supported: 0-7</div><div class="line">        VHT Capabilities (0x000003b2):</div><div class="line">            Max MPDU length: 11454</div><div class="line">            Supported Channel Width: neither 160 nor 80+80</div><div class="line">            RX LDPC</div><div class="line">            short GI (80 MHz)</div><div class="line">            TX STBC</div><div class="line">        VHT RX MCS set:</div><div class="line">            1 streams: MCS 0-7</div><div class="line">            2 streams: MCS 0-7</div><div class="line">            3 streams: MCS 0-7</div><div class="line">            4 streams: MCS 0-7</div><div class="line">            5 streams: MCS 0-7</div><div class="line">            6 streams: MCS 0-7</div><div class="line">            7 streams: MCS 0-7</div><div class="line">            8 streams: MCS 0-7</div><div class="line">        VHT RX highest supported: 0 Mbps</div><div class="line">        VHT TX MCS set:</div><div class="line">            1 streams: MCS 0-7</div><div class="line">            2 streams: MCS 0-7</div><div class="line">            3 streams: MCS 0-7</div><div class="line">            4 streams: MCS 0-7</div><div class="line">            5 streams: MCS 0-7</div><div class="line">            6 streams: MCS 0-7</div><div class="line">            7 streams: MCS 0-7</div><div class="line">            8 streams: MCS 0-7</div><div class="line">        VHT TX highest supported: 0 Mbps</div><div class="line">        Bitrates (non-HT):</div><div class="line">            * 6.0 Mbps</div><div class="line">            * 9.0 Mbps</div><div class="line">            * 12.0 Mbps</div><div class="line">            * 18.0 Mbps</div><div class="line">            * 24.0 Mbps</div><div class="line">            * 36.0 Mbps</div><div class="line">            * 48.0 Mbps</div><div class="line">            * 54.0 Mbps</div><div class="line">        Frequencies:</div><div class="line">            * 4920 MHz [184] (disabled)</div><div class="line">            * 4940 MHz [188] (disabled)</div><div class="line">            * 4960 MHz [192] (disabled)</div><div class="line">            * 4980 MHz [196] (disabled)</div><div class="line">            * 5040 MHz [8] (disabled)</div><div class="line">            * 5060 MHz [12] (disabled)</div><div class="line">            * 5080 MHz [16] (disabled)</div><div class="line">            * 5180 MHz [36] (23.0 dBm)</div><div class="line">            * 5200 MHz [40] (23.0 dBm)</div><div class="line">            * 5220 MHz [44] (23.0 dBm)</div><div class="line">            * 5240 MHz [48] (23.0 dBm)</div><div class="line">            * 5260 MHz [52] (23.0 dBm) (radar detection)</div><div class="line">            * 5280 MHz [56] (23.0 dBm) (radar detection)</div><div class="line">            * 5300 MHz [60] (23.0 dBm) (radar detection)</div><div class="line">            * 5320 MHz [64] (23.0 dBm) (radar detection)</div><div class="line">            * 5500 MHz [100] (disabled)</div><div class="line">            * 5520 MHz [104] (disabled)</div><div class="line">            * 5540 MHz [108] (disabled)</div><div class="line">            * 5560 MHz [112] (disabled)</div><div class="line">            * 5580 MHz [116] (disabled)</div><div class="line">            * 5600 MHz [120] (disabled)</div><div class="line">            * 5620 MHz [124] (disabled)</div><div class="line">            * 5640 MHz [128] (disabled)</div><div class="line">            * 5660 MHz [132] (disabled)</div><div class="line">            * 5680 MHz [136] (disabled)</div><div class="line">            * 5700 MHz [140] (disabled)</div><div class="line">            * 5720 MHz [144] (disabled)</div><div class="line">            * 5745 MHz [149] (30.0 dBm)</div><div class="line">            * 5765 MHz [153] (30.0 dBm)</div><div class="line">            * 5785 MHz [157] (30.0 dBm)</div><div class="line">            * 5805 MHz [161] (30.0 dBm)</div><div class="line">            * 5825 MHz [165] (30.0 dBm)</div><div class="line">            * 5852 MHz [170] (disabled)</div><div class="line">            * 5855 MHz [171] (disabled)</div><div class="line">            * 5860 MHz [172] (disabled)</div><div class="line">            * 5865 MHz [173] (disabled)</div><div class="line">            * 5870 MHz [174] (disabled)</div><div class="line">            * 5875 MHz [175] (disabled)</div><div class="line">            * 5880 MHz [176] (disabled)</div><div class="line">            * 5885 MHz [177] (disabled)</div><div class="line">            * 5890 MHz [178] (disabled)</div><div class="line">            * 5895 MHz [179] (disabled)</div><div class="line">            * 5900 MHz [180] (disabled)</div><div class="line">            * 5905 MHz [181] (disabled)</div><div class="line">            * 5910 MHz [182] (disabled)</div><div class="line">            * 5915 MHz [183] (disabled)</div><div class="line">            * 5920 MHz [184] (disabled)</div><div class="line">    Supported commands:</div><div class="line">         * new_interface</div><div class="line">         * set_interface</div><div class="line">         * new_key</div><div class="line">         * start_ap</div><div class="line">         * new_station</div><div class="line">         * set_bss</div><div class="line">         * join_ibss</div><div class="line">         * set_pmksa</div><div class="line">         * del_pmksa</div><div class="line">         * flush_pmksa</div><div class="line">         * remain_on_channel</div><div class="line">         * frame</div><div class="line">         * frame_wait_cancel</div><div class="line">         * set_channel</div><div class="line">         * tdls_mgmt</div><div class="line">         * tdls_oper</div><div class="line">         * testmode</div><div class="line">         * channel_switch</div><div class="line">         * connect</div><div class="line">         * disconnect</div><div class="line">    Supported TX frame types:</div><div class="line">         * IBSS: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0</div><div class="line">         * managed: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0</div><div class="line">         * AP: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0</div><div class="line">         * P2P-client: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0</div><div class="line">         * P2P-GO: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0</div><div class="line">    Supported RX frame types:</div><div class="line">         * IBSS: 0x00 0x20 0x40 0xa0 0xb0 0xc0 0xd0</div><div class="line">         * managed: 0x40 0xd0</div><div class="line">         * AP: 0x00 0x20 0x40 0xa0 0xb0 0xc0 0xd0</div><div class="line">         * P2P-client: 0x40 0xd0</div><div class="line">         * P2P-GO: 0x00 0x20 0x40 0xa0 0xb0 0xc0 0xd0</div><div class="line">    WoWLAN support:</div><div class="line">         * wake up on anything (device continues operating normally)</div><div class="line">         * wake up on disconnect</div><div class="line">         * wake up on magic packet</div><div class="line">         * wake up on pattern match, up to 4 patterns of 6-64 bytes,</div><div class="line">           maximum packet offset 0 bytes</div><div class="line">         * can do GTK rekeying</div><div class="line">         * wake up on GTK rekey failure</div><div class="line">         * wake up on EAP identity request</div><div class="line">         * wake up on 4-way handshake</div><div class="line">         * wake up on rfkill release</div><div class="line">    software interface modes (can always be added):</div><div class="line">    valid interface combinations:</div><div class="line">         * #&#123; managed &#125; &lt;= 3,</div><div class="line">           total &lt;= 3, #channels &lt;= 2</div><div class="line">         * #&#123; managed &#125; &lt;= 1, #&#123; IBSS &#125; &lt;= 1,</div><div class="line">           total &lt;= 2, #channels &lt;= 1</div><div class="line">         * #&#123; AP &#125; &lt;= 2,</div><div class="line">           total &lt;= 2, #channels &lt;= 2</div><div class="line">         * #&#123; P2P-client &#125; &lt;= 1, #&#123; P2P-GO &#125; &lt;= 1,</div><div class="line">           total &lt;= 2, #channels &lt;= 2</div><div class="line">         * #&#123; managed &#125; &lt;= 2, #&#123; AP &#125; &lt;= 1,</div><div class="line">           total &lt;= 3, #channels &lt;= 2, STA/AP BI must match</div><div class="line">         * #&#123; managed &#125; &lt;= 2, #&#123; P2P-client, P2P-GO &#125; &lt;= 2,</div><div class="line">           total &lt;= 4, #channels &lt;= 2, STA/AP BI must match</div><div class="line">         * #&#123; managed &#125; &lt;= 2, #&#123; P2P-GO &#125; &lt;= 1, #&#123; AP &#125; &lt;= 1,</div><div class="line">           total &lt;= 4, #channels &lt;= 2, STA/AP BI must match</div><div class="line">    Device supports HT-IBSS.</div><div class="line">    Device supports scan flush.</div></pre></td></tr></table></figure><p>该芯片是支持这些功能</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Supported interface modes:</div><div class="line">         * IBSS</div><div class="line">         * managed</div><div class="line">         * AP</div><div class="line">         * P2P-client</div><div class="line">         * P2P-GO</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">root@oneplus3:/ # iw dev</div><div class="line">phy#0</div><div class="line">    Interface p2p0</div><div class="line">        ifindex 24</div><div class="line">        wdev 0x2</div><div class="line">        addr c2:ee:fb:d6:08:0d</div><div class="line">        type managed</div><div class="line">    Interface wlan0</div><div class="line">        ifindex 23</div><div class="line">        wdev 0x1</div><div class="line">        addr c0:ee:fb:d6:08:0d</div><div class="line">        ssid BIUBIU_5G</div><div class="line">        type managed</div></pre></td></tr></table></figure><p>网卡有两个 interface，默认启用了 p2p 接口，但开启系统的热点功能后</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">root@oneplus3:/ # iw dev</div><div class="line">phy#1</div><div class="line">    Interface wlan0</div><div class="line">        ifindex 27</div><div class="line">        wdev 0x100000001</div><div class="line">        addr c0:ee:fb:d6:08:0d</div><div class="line">        ssid ONEPLUS A3000</div><div class="line">        type AP</div></pre></td></tr></table></figure><p>p2p0 端口消失，只剩下了 wlan0 端口，查看 hostapd 进程的 cmdline</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">root@oneplus3:/ # cat /proc/11047/cmdline</div><div class="line">/system/bin/hostapd -e /data/misc/wifi/entropy.bin /data/misc/wifi/hostapd.conf</div></pre></td></tr></table></figure><p>先前的 wpa_supplicant 进程是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@oneplus3:/ # cat /proc/11257/cmdline</div><div class="line">/system/bin/wpa_supplicant -ip2p0- Dnl80211 -c/data/misc/wifi/p2p_supplicant.conf -I/system/etc/wifi/p2p_supplicant_overlay.conf -N -iwlan0 -Dnl80211 -c/data/misc/wifi/wpa_supplicant.conf -I/system/etc/wifi/wpa_supplicant_overlay.conf -O/data/misc/wifi/sockets -puse_p2p_group_interface=1 -e/data/misc/wi</div><div class="line">fi/entropy.bin</div></pre></td></tr></table></figure><p>wpa_supplicant 同时管理着 p2p0 wlan0 两个 interface，p2p0 interface 的状态</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">root@oneplus3:/data/local/tmp # ./wpa_cli -p /data/misc/wifi/sockets/ -i p2p0 status</div><div class="line">wpa_state=DISCONNECTED</div><div class="line">p2p_device_address=c2:ee:fb:d6:08:0d</div><div class="line">address=c2:ee:fb:d6:08:0d</div><div class="line">uuid=4227ede7-6911-52a9-987c-6ce45048dfe1</div></pre></td></tr></table></figure><p>处于未连接状态，使用 <a href="https://android.googlesource.com/platform/external/wpa_supplicant_8/+/android-7.1.2_r6/wpa_supplicant/README-P2P" target="_blank" rel="external">wpa_cli</a> 直接添加一个固定的 p2p 分组， wpa_cli 支持交互模式。进行此操作之前，备份一下 <code>/data/misc/wifi/p2p_supplicant.conf</code>，防止出错</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">root@oneplus3:/data/local/tmp # ./wpa_cli -p /data/misc/wifi/sockets/ -i p2p0</div><div class="line">wpa_cli v2.5-devel-6.0.1</div><div class="line">Copyright (c) 2004-2015, Jouni Malinen &lt;j@w1.fi&gt; and contributors</div><div class="line"></div><div class="line">This software may be distributed under the terms of the BSD license.</div><div class="line">See README for more details.</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">Interactive mode</div><div class="line"></div><div class="line">&gt; add_network</div><div class="line">0</div><div class="line">&gt; set_network 0 mode 3</div><div class="line">OK</div><div class="line">&gt; set_network 0 disabled 2</div><div class="line">OK</div><div class="line">&gt; set_network 0 ssid &quot;loopax&quot;</div><div class="line">OK</div><div class="line">&gt; set_network 0 key_mgmt WPA-PSK</div><div class="line">OK</div><div class="line">&gt; set_network 0 proto RSN</div><div class="line">OK</div><div class="line">&gt; set_network 0 pairwise CCMP</div><div class="line">OK</div><div class="line">&gt; set_network 0 psk &quot;12345678&quot;</div><div class="line">OK</div><div class="line">&gt; save_config</div><div class="line">OK</div><div class="line">&gt; list_network</div><div class="line">network id / ssid / bssid / flags</div><div class="line">0   loopax  any [DISABLED][P2P-PERSISTENT]</div><div class="line">&gt; p2p_group_add persistent=0</div><div class="line">OK</div><div class="line">&lt;3&gt;P2P-GROUP-STARTED p2p-p2p0-0 GO ssid=&quot;loopax&quot; freq=5765 passphrase=&quot;12345678&quot; go_dev_addr=c2:ee:fb:d6:08:0d [PERSISTENT]</div><div class="line">&gt; quit</div></pre></td></tr></table></figure><p>此时，热点就起来了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">root@oneplus3:/ # iw dev</div><div class="line">phy#3</div><div class="line">    Interface p2p-p2p0-0</div><div class="line">        ifindex 33</div><div class="line">        wdev 0x300000003</div><div class="line">        addr c2:ee:fb:d6:88:0d</div><div class="line">        ssid loopax</div><div class="line">        type P2P-GO</div><div class="line">    Interface p2p0</div><div class="line">        ifindex 32</div><div class="line">        wdev 0x300000002</div><div class="line">        addr c2:ee:fb:d6:08:0d</div><div class="line">        type managed</div><div class="line">    Interface wlan0</div><div class="line">        ifindex 31</div><div class="line">        wdev 0x300000001</div><div class="line">        addr c0:ee:fb:d6:08:0d</div><div class="line">        ssid BIUBIU_5G</div><div class="line">        type managed</div></pre></td></tr></table></figure><p>起来了一个新的接口 p2p-p2p0-0，type 是 P2P-GO, 该接口状态</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">root@oneplus3:/data/local/tmp # ./wpa_cli -p /data/misc/wifi/sockets/ -i p2p-p2p0-0 status</div><div class="line">bssid=c2:ee:fb:d6:88:0d</div><div class="line">freq=5765</div><div class="line">ssid=loopax</div><div class="line">id=0</div><div class="line">mode=P2P GO</div><div class="line">pairwise_cipher=CCMP</div><div class="line">group_cipher=CCMP</div><div class="line">key_mgmt=WPA2-PSK</div><div class="line">wpa_state=COMPLETED</div><div class="line">ip_address=192.168.49.1</div><div class="line">p2p_device_address=c2:ee:fb:d6:08:0d</div><div class="line">address=c2:ee:fb:d6:88:0d</div><div class="line">uuid=4227ede7-6911-52a9-987c-6ce45048dfe1</div></pre></td></tr></table></figure><p>热点可以正常连接，但是不能够上网，也 ping 不通 IP，开启设备的网络转发 和 NAT</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">root@oneplus3:/ # echo 1 &gt; /proc/sys/net/ipv4/ip_forward</div><div class="line">root@oneplus3:/ # iptables -F</div><div class="line">root@oneplus3:/ # iptables -P INPUT ACCEPT</div><div class="line">root@oneplus3:/ # iptables -P FORWARD ACCEPT</div><div class="line">root@oneplus3:/ # iptables -t nat -A POSTROUTING -o wlan0 -j MASQUERADE</div></pre></td></tr></table></figure><p>这样 ip 就能 ping 的通了，但是 DNS 还是不正常，连接热点的设备手动设置 DNS 的话，就可以正常上网了。重启系统的 dnsmasq，让 DHCP 自动分配 DNS</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@oneplus3:/ # killall dnsmasq</div><div class="line">root@oneplus3:/ # /system/bin/dnsmasq --no-resolv --no-poll --dhcp-authoritative --server=114.114.114.114 --dhcp-option-force=43,ANDROID_METERED --pid-file --dhcp-range=192</div><div class="line">.168.49.2,192.168.49.254,1h</div></pre></td></tr></table></figure><p>这样就是配置了一个完整的 wifi 中继了。</p><p>再次开启中继只需</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">root@oneplus3:/data/local/tmp # ./wpa_cli -p /data/misc/wifi/sockets/ -i p2p0 p2p_group_add persistent=0</div></pre></td></tr></table></figure><p>然后在配置网络转发，和 iptables、 dhcp。</p><p>默认两个接口是使用同样的 channel，但是也是可以指定频道的,如</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">root@oneplus3:/data/local/tmp # ./wpa_cli -p /data/misc/wifi/sockets/ -i p2p0 p2p_group_add persistent=0 freq=5825</div></pre></td></tr></table></figure><p>获取 channel 信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">root@oneplus3:/ # iwlist wlan0 channel</div><div class="line">wlan0     26 channels in total; available frequencies :</div><div class="line">          Channel 01 : 2.412 GHz</div><div class="line">          Channel 02 : 2.417 GHz</div><div class="line">          Channel 03 : 2.422 GHz</div><div class="line">          Channel 04 : 2.427 GHz</div><div class="line">          Channel 05 : 2.432 GHz</div><div class="line">          Channel 06 : 2.437 GHz</div><div class="line">          Channel 07 : 2.442 GHz</div><div class="line">          Channel 08 : 2.447 GHz</div><div class="line">          Channel 09 : 2.452 GHz</div><div class="line">          Channel 10 : 2.457 GHz</div><div class="line">          Channel 11 : 2.462 GHz</div><div class="line">          Channel 12 : 2.467 GHz</div><div class="line">          Channel 13 : 2.472 GHz</div><div class="line">          Channel 36 : 5.18 GHz</div><div class="line">          Channel 40 : 5.2 GHz</div><div class="line">          Channel 44 : 5.22 GHz</div><div class="line">          Channel 48 : 5.24 GHz</div><div class="line">          Channel 52 : 5.26 GHz</div><div class="line">          Channel 56 : 5.28 GHz</div><div class="line">          Channel 60 : 5.3 GHz</div><div class="line">          Channel 64 : 5.32 GHz</div><div class="line">          Channel 149 : 5.745 GHz</div><div class="line">          Channel 153 : 5.765 GHz</div><div class="line">          Channel 157 : 5.785 GHz</div><div class="line">          Channel 161 : 5.805 GHz</div><div class="line">          Channel 165 : 5.825 GHz</div><div class="line">          Current Frequency:5.765 GHz (Channel 153)</div></pre></td></tr></table></figure><p>可在 <code>/data/misc/dhcp/dnsmasq.leases</code> 文件中查看连接的客户端。</p><h2 id="参考"><a class="header-anchor" href="#参考">¶ </a>参考</h2><ul><li><a href="http://fqrouter.tumblr.com/post/47259845553/%E6%97%A0%E7%BA%BF%E4%B8%AD%E7%BB%A7%E5%90%AF%E5%8A%A8%E7%9A%84%E6%9D%A1%E4%BB%B6" target="_blank" rel="external">无线中继启动的条件</a></li><li><a href="http://fqrouter.tumblr.com/post/43575459548/%E4%BD%BF%E7%94%A8%E6%89%8B%E6%9C%BA%E5%81%9A%E6%97%A0%E7%BA%BF%E4%B8%AD%E7%BB%A7%E7%9A%84%E5%8F%AF%E8%83%BD%E6%80%A7%E6%8E%A2%E5%AF%BB" target="_blank" rel="external">使用手机做无线中继的可能性探寻</a></li><li><a href="http://fqrouter.tumblr.com/post/44298169558/%E8%81%94%E6%83%B3p770%E6%89%8B%E6%9C%BAmtk6577%E6%97%A0%E7%BA%BF%E4%B8%AD%E7%BB%A7%E8%84%9A%E6%9C%AC%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95" target="_blank" rel="external">联想P770手机（MTK6577）无线中继脚本配置方法</a></li><li><a href="https://github.com/fqrouter/fqrouter/blob/master/manager/wifi.py" target="_blank" rel="external">wifi repeater start script</a></li><li><a href="http://lists.shmoo.com/pipermail/hostap/2012-November/026931.html" target="_blank" rel="external">PATCH</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;隔壁学校的 wifi 网络不错，但是因为离得远，信号差，只能在窗户边能连得上。买了一个 360 wifi 中继器，但速度掉的厉害，而用手机直接连接网速倒是正常，就想着把手机作为 wifi 中继器。记得自己的第一台 android 手机，中兴 v880 当时是支持 wifi 中继的，一边连着 wifi，一边扩展 wifi 信号，后来才知道那算是中兴特有的。找了一圈，并没有找到这样的 APP，fqrouter2 倒是有这个功能，但是作者已经停止维护，在我手机上直接启动失败。参考 fqrouter2 的文章和脚本终于让 oneplus3 STA+AP 一起工作了。&lt;/p&gt;
&lt;h2 id=&quot;使用一加3做-wifi-中继器脚本配置&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#使用一加3做-wifi-中继器脚本配置&quot;&gt;¶ &lt;/a&gt;使用一加3做 wifi 中继器脚本配置&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;ONEPLUS A3000&lt;/li&gt;
&lt;li&gt;系统 cm-13.0, Android 6.0.1&lt;/li&gt;
&lt;li&gt;root 权限&lt;/li&gt;
&lt;li&gt;iw iwlist wpa_cli 等二进制文件&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="Android" scheme="http://blog.omitol.com/categories/Android/"/>
    
    
      <category term="Openwrt-x86" scheme="http://blog.omitol.com/tags/Openwrt-x86/"/>
    
  </entry>
  
  <entry>
    <title>华为 EMUI 5.0 root 方法</title>
    <link href="http://blog.omitol.com/2016/12/21/huawei-EMUI50-rootway/"/>
    <id>http://blog.omitol.com/2016/12/21/huawei-EMUI50-rootway/</id>
    <published>2016-12-20T16:00:00.000Z</published>
    <updated>2017-09-30T12:46:11.000Z</updated>
    
    <content type="html"><![CDATA[<p>华为 EMUI 5.0 root 方法和分析</p><h3 id="华为-emui5-0-获取-root-方法"><a class="header-anchor" href="#华为-emui5-0-获取-root-方法">¶ </a>华为 EMUI5.0 获取 root 方法</h3><p>华为EMUI5.0 目前 root 方法是刷TWRP，然后使用 TWRP 刷入 Chainfire 的 SuperSU 或者 phh 的 Superuser。你需要支持 Nougat 版本的 TWRP，但是在刷入 Chainfire 的 SuperSU 过程中会直接导致设备重启，因为 SuperSU 的工作原理是在采用 systemless 时无论在刷入还是开机过程中都需要 mount 一个 loop 设备 su.img，猜测是华为的 kernel 做了限制，当 mount 一个 loop 设备时设备会直接重启最后进入到 erecovery.</p><a id="more"></a><p>使用 phh 的 Superuser 则无此问题，但是默认提供的 Superuser 版本是开启了 dm-verity 和 forceencrypt，因为 dm-verity 的存在导致获取到的 root 权限是不完整的，无法对 system 分区做任何修改，所以自己修改了一个 Superuser-r275 的版本，关闭了这两个开关.</p><p>同时也借鉴 phh 的做法，将 SuperSU 相关 su 文件放到 ramdisk 下并移除 su.img 的创建和挂载过程，最后对 sepolicy 重新打 patch，这部分脚本完全来自 phh 的 Superuser. 但是因此也失去了 SuperSU 特有的一些功能，例如 frp 和 app 内更新二进制的功能，升级版本只能通过重刷来解决.</p><p>至于最终到底是不是华为 kernel的限制，还是需要等华为开源时，才能最终解决.</p><h2 id="frd-al00-root-所需文件"><a class="header-anchor" href="#frd-al00-root-所需文件">¶ </a>FRD-AL00 root 所需文件</h2><p>自己测试的机器是荣耀8 FRD-AL00 版本，需要到的文件：</p><ul><li><a href="https://mega.nz/#!XR91RJrL!zKgVWf8WvBGlP3n0Aip59tT1Z3l8C2Lh6smsijw3wQQ" target="_blank" rel="external">frd-twrp</a></li><li><a href="https://mega.nz/#!2Y8CgIDa!RvUXD1dJKYA0xBPHRfzVy0wj_CZXPw-bMdZJLpypHUY" target="_blank" rel="external">SuperSU</a></li><li><a href="https://mega.nz/#!PYshWCZZ!SwrpezliztIFKooEY5Np7zT2m7yWmp6QtjlTExntakU" target="_blank" rel="external">phh Superuser</a></li></ul><p>该 recovery 应该也同样适用于华为P9,或者其他的 hi3650 机器.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;华为 EMUI 5.0 root 方法和分析&lt;/p&gt;
&lt;h3 id=&quot;华为-emui5-0-获取-root-方法&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#华为-emui5-0-获取-root-方法&quot;&gt;¶ &lt;/a&gt;华为 EMUI5.0 获取 root 方法&lt;/h3&gt;
&lt;p&gt;华为EMUI5.0 目前 root 方法是刷TWRP，然后使用 TWRP 刷入 Chainfire 的 SuperSU 或者 phh 的 Superuser。你需要支持 Nougat 版本的 TWRP，但是在刷入 Chainfire 的 SuperSU 过程中会直接导致设备重启，因为 SuperSU 的工作原理是在采用 systemless 时无论在刷入还是开机过程中都需要 mount 一个 loop 设备 su.img，猜测是华为的 kernel 做了限制，当 mount 一个 loop 设备时设备会直接重启最后进入到 erecovery.&lt;/p&gt;
    
    </summary>
    
      <category term="Android" scheme="http://blog.omitol.com/categories/Android/"/>
    
    
      <category term="root" scheme="http://blog.omitol.com/tags/root/"/>
    
  </entry>
  
  <entry>
    <title>生成用于 Verifiedboot 的 system.img</title>
    <link href="http://blog.omitol.com/2016/07/05/buid-verifiedboot-system-image/"/>
    <id>http://blog.omitol.com/2016/07/05/buid-verifiedboot-system-image/</id>
    <published>2016-07-05T07:53:41.000Z</published>
    <updated>2017-10-02T08:36:17.000Z</updated>
    
    <content type="html"><![CDATA[<p>Android 从 6.0 开始启用了 Verifiedboot，来保证系统的完整性</p><h2 id="getveritytreesize-和-getveritymetadatasize"><a class="header-anchor" href="#getveritytreesize-和-getveritymetadatasize">¶ </a>GetVerityTreeSize 和 GetVerityMetadataSize</h2><p><code>build_verity_tree -s 2046820352</code></p><p><code>build_verity_metadata.py -s 2046820352</code></p><p>该两个方法在源码的 <code>./tools/releasetools/build_image.py</code> 中.</p><p>参数是真实 system 分区的大小</p><h2 id="生成预留空间的-system-simg"><a class="header-anchor" href="#生成预留空间的-system-simg">¶ </a>生成预留空间的 system.simg</h2><p>要重新打包 system.simg 给 verity_tree 和 verity_metadata 预留出空间，<code>-l</code>指定的大小为真实 system 空间的大小减去上一步分别得到的大小</p><a id="more"></a><h2 id="生成-root-hash-即-verity-tree"><a class="header-anchor" href="#生成-root-hash-即-verity-tree">¶ </a>生成 root_hash 即 verity_tree</h2><p><code>build_verity_tree -A aee087a5be3b982978c923f566a94613496b417f2af592639bc80d141e34dfe7 system.simg verity.img</code></p><p>其中 <code>aee087a5be3b982978c923f566a94613496b417f2af592639bc80d141e34dfe7</code> 是 salt，<code>system.simg</code> 需要是 sparse image，生成 verity.img.</p><p>命令输出例子</p><p><code>3a82cfc74206a6a8b467fb699022d86ea36dee48b04fc8b40585d2cad941f463 aee087a5be3b982978c923f566a94613496b417f2af592639bc80d141e34dfe7</code></p><p>第一个就是后面要用到的 root_hash 值。</p><h2 id="生成-verity-metadata"><a class="header-anchor" href="#生成-verity-metadata">¶ </a>生成 verity_metadata</h2><p><code>build_verity_metadata.py 2030665728 verity_metadata.img 3a82cfc74206a6a8b467fb699022d86ea36dee48b04fc8b40585d2cad941f463 aee087a5be3b982978c923f566a94613496b417f2af592639bc80d141e34dfe7 /dev/block/platform/msm_sdcc.1/by-name/system verity_signer verity.pk8</code></p><p>其中第一个参数是预留了空间后的 system 大小，后面的分别是 root_hash、salt、system 分区在手机里的分区、signer_path、私钥。最后生成 verity_metadata.img，32768 个字节 32kb 是固定值。</p><h2 id="生成最终的-image"><a class="header-anchor" href="#生成最终的-image">¶ </a>生成最终的 image</h2><p><code>append2simg system.simg verity_metadata.img</code></p><p><code>append2simg system.simg verity.img</code></p><p>分别是前两步中生成的文件。</p><h2 id="参考"><a class="header-anchor" href="#参考">¶ </a>参考</h2><ul><li><a href="http://blog.andrsec.com/android/2015/04/10/android-boot-verity.html" target="_blank" rel="external">Android secrue boot</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Android 从 6.0 开始启用了 Verifiedboot，来保证系统的完整性&lt;/p&gt;
&lt;h2 id=&quot;getveritytreesize-和-getveritymetadatasize&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#getveritytreesize-和-getveritymetadatasize&quot;&gt;¶ &lt;/a&gt;GetVerityTreeSize 和 GetVerityMetadataSize&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;build_verity_tree -s 2046820352&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;build_verity_metadata.py -s 2046820352&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;该两个方法在源码的 &lt;code&gt;./tools/releasetools/build_image.py&lt;/code&gt; 中.&lt;/p&gt;
&lt;p&gt;参数是真实 system 分区的大小&lt;/p&gt;
&lt;h2 id=&quot;生成预留空间的-system-simg&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#生成预留空间的-system-simg&quot;&gt;¶ &lt;/a&gt;生成预留空间的 system.simg&lt;/h2&gt;
&lt;p&gt;要重新打包 system.simg 给 verity_tree 和 verity_metadata 预留出空间，&lt;code&gt;-l&lt;/code&gt;指定的大小为真实 system 空间的大小减去上一步分别得到的大小&lt;/p&gt;
    
    </summary>
    
      <category term="Android" scheme="http://blog.omitol.com/categories/Android/"/>
    
    
      <category term="verifiedboot" scheme="http://blog.omitol.com/tags/verifiedboot/"/>
    
  </entry>
  
  <entry>
    <title>采用 LVM 扩展 Home 分区</title>
    <link href="http://blog.omitol.com/2016/07/05/use-lvm-spread-home-partition/"/>
    <id>http://blog.omitol.com/2016/07/05/use-lvm-spread-home-partition/</id>
    <published>2016-07-05T02:52:41.000Z</published>
    <updated>2017-09-30T19:11:15.000Z</updated>
    
    <content type="html"><![CDATA[<p>电脑是双系统，从windows下压缩出了部分空间，来扩展ubuntu的home分区</p><h2 id="创建lvm"><a class="header-anchor" href="#创建lvm">¶ </a>创建lvm</h2><p><code>sudo apt-get install lvm2</code></p><p><code>sudo fdisk /dev/sda</code>,新建分区后，输入<code>t</code>，输入要改变分区类型的分区号，输入<code>8e</code>，最后<code>w</code>保存。</p><p><code>sudo partprobe</code> 重读分区表,此时可能需要重启一下，要不下面一步会提示not found.</p><p><code>sudo pvcreate /dev/sda4</code>  创建物理卷PV，让刚刚的分区可用</p><a id="more"></a><p><code>sudo pvdisplay</code> 查看PV</p><p><code>sudo vgcreate ext_vol /dev/sda4</code> 创建逻辑卷组VG，创建完毕之后，可以在/dev/下面看见设备</p><p><code>sudo vgdisplay</code> 查看VG</p><p><code>sudo lvcreate --name home --size 48G ext_vol</code> 创建逻辑卷分区LV，创建完毕之后，就可以在/dev/ext_vol/下看见分区了，然后这个分区就可以操作了<br>或者<code>sudo lvcreate --name home -l +100%FREE 48G ext_vol</code>,使用全部空间</p><p><code>sudo lvdisplay</code></p><p><code>sudo mkfs.ext4 /dev/ext_vol/home</code> 格式化</p><p>然后就可以挂载使用了</p><h2 id="迁移home分区"><a class="header-anchor" href="#迁移home分区">¶ </a>迁移home分区</h2><p>进入rescue mode模式，把原先的home分区挂载到/home目录下，把<code>/dev/ext_vol/home</code>挂载到/home1目录下，操作前要让分区可写<code>mount -o remount rw /</code>,然后<code>cp -afR /home/* /home1</code>,最后修改<code>/etc/fstab</code>自动挂载。</p><h2 id="将原先的home分区也添加到lvm中"><a class="header-anchor" href="#将原先的home分区也添加到lvm中">¶ </a>将原先的home分区也添加到lvm中</h2><ul><li>修改分区类型为8e</li><li>重载分区表</li><li>格式化</li><li>创建PV</li><li><code>sudo vgextend ext_vol /dev/sda8</code> #扩展逻辑卷组ext_vol</li><li><code>sudo lvextend -l +100%FREE /dev/ext_vol/home</code> 扩容LV的home分区，使用全部的VG空间</li><li>再次进入rescue mod模式下，<code>resize2fs /dev/ext_vol/home</code></li></ul><h2 id="参考"><a class="header-anchor" href="#参考">¶ </a>参考</h2><ul><li><a href="http://www.cnblogs.com/gaojun/archive/2012/08/22/2650229.html" target="_blank" rel="external">Linux LVM硬盘管理及LVM扩容</a></li><li><a href="http://www.cnblogs.com/yasmi/articles/4835644.html" target="_blank" rel="external">Ubuntu Server上的LVM配置</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;电脑是双系统，从windows下压缩出了部分空间，来扩展ubuntu的home分区&lt;/p&gt;
&lt;h2 id=&quot;创建lvm&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#创建lvm&quot;&gt;¶ &lt;/a&gt;创建lvm&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;sudo apt-get install lvm2&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;sudo fdisk /dev/sda&lt;/code&gt;,新建分区后，输入&lt;code&gt;t&lt;/code&gt;，输入要改变分区类型的分区号，输入&lt;code&gt;8e&lt;/code&gt;，最后&lt;code&gt;w&lt;/code&gt;保存。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;sudo partprobe&lt;/code&gt; 重读分区表,此时可能需要重启一下，要不下面一步会提示not found.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;sudo pvcreate /dev/sda4&lt;/code&gt;  创建物理卷PV，让刚刚的分区可用&lt;/p&gt;
    
    </summary>
    
      <category term="Ubuntu" scheme="http://blog.omitol.com/categories/Ubuntu/"/>
    
    
      <category term="LVM" scheme="http://blog.omitol.com/tags/LVM/"/>
    
  </entry>
  
  <entry>
    <title>关于高通 9008 刷机的研究</title>
    <link href="http://blog.omitol.com/2015/09/01/about-qcom-edl-dload-study/"/>
    <id>http://blog.omitol.com/2015/09/01/about-qcom-edl-dload-study/</id>
    <published>2015-08-31T16:00:00.000Z</published>
    <updated>2017-10-11T09:57:42.035Z</updated>
    
    <content type="html"><![CDATA[<h2 id="生成所需xml"><a class="header-anchor" href="#生成所需xml">¶ </a>生成所需xml</h2><h3 id="gpt-分区-parse-gpt"><a class="header-anchor" href="#gpt-分区-parse-gpt">¶ </a>GPT 分区 parse_gpt</h3><p>根据官方 GPT 文件解析出具体的 GPT 的分区信息并生成对应平台的 partiiton.xml 文件，最后通过 <a href="http://ptool.py" target="_blank" rel="external">ptool.py</a> 生成可刷写的配置文件 rawprogram0.xml、patch0.xml 跟最后的 GPT。</p><p>官方的 gpt 文件一般需要经过裁剪,一般裁剪成 17408 字节大小，包括文件头开始的 512 字节的 MBR 信息 <code>dd if=gpt.bin of=gpt-new.bin bs=17408 count=1</code>,然后使用 <code>./parse_gpt gpt-new.bin</code>，输出在 <code>GPT_DUNP_FILES</code> 中。</p><p>或者在手机中 <code>dd if=/dev/block/mmcblk0 of=/sdcard/gpt-new.bin bs=17408 count=1</code>，为配合 parse_gpt,大小一般为 17408/34304。</p><a id="more"></a><h3 id="mbr-分区"><a class="header-anchor" href="#mbr-分区">¶ </a>MBR 分区</h3><p>上面所说的是 GPT 分区的，但是一些老平台的机器依然使用的是 MBR 分区，例如 msm7x30 和 msm8x60 平台</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">partition.xml           - Everything begins with this file, which describes the number of </div><div class="line">                          partitions desired, and how many sectors each one should be.</div><div class="line">PartitioningTool.py     - translates partition.xml into binary partitions</div><div class="line">msp.exe                 - writes binary partitions to SD/eMMC cards using card reader</div><div class="line">mjsdload.cmm            - writes binary partitions to SD/eMMC cards using Trace32</div><div class="line">msp.py                  - writes binary partitions to a single image file</div><div class="line">QPST                    - writes binary partitions to SD/eMMC cards on Target</div><div class="line">parseBinaryPartitionFile.pl     - Decodes MBR partition tables. Run: </div><div class="line">                                  &quot;Perl parseBinaryPartitionFile.pl partition.bin&quot; </div><div class="line">                                  to generate the partition information</div><div class="line">parseGPT.pl                     - Decodes GPT partition tables</div></pre></td></tr></table></figure><ul><li><a href="http://forum.xda-developers.com/showthread.php?p=31843325" target="_blank" rel="external">eMMC Partition tools usage for msm7x30/msm8x60</a></li></ul><h3 id="ptool-py"><a class="header-anchor" href="#ptool-py">¶ </a><a href="http://ptool.py" target="_blank" rel="external">ptool.py</a></h3><p><code>python ptool.py –x partition.xml</code></p><p>这些工具源于高通的 modem 源码，当然是闭源的了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">boot_images/core/storage/tools/ptool/</div><div class="line">ptool.py         //分区生成工具 partition =========&gt; rawprogram0.xml</div><div class="line">                    Python ptool.py –x partition.xml:</div><div class="line">msp.py          //ubuntu使用：根据 rawprogram0.xml进行升级软件工具</div><div class="line">singleimage.py　　//根据singleimage_partition_8974.xml生成single boot image: 8974_msimage.mbn, python singleimage.py -x singleimage_partition_8974.xml</div><div class="line">lsusb.py       // ls usb</div><div class="line">dd.py            // dd command</div><div class="line">checksparse.py         //sparse system/cache/userdata image</div><div class="line"></div><div class="line">[checksparse.py的使用](http://kernel-develop.blogspot.com/2012/06/emmc-sparse-image-download-in-msm8x60.html)</div></pre></td></tr></table></figure><p>一个整合的工具，包括刷机命令行刷机的 <code>qdload.pl</code></p><ul><li><a href="https://github.com/M1cha/aries-image-builder" target="_blank" rel="external">aries-image-builder</a></li></ul><h3 id="文件说明"><a class="header-anchor" href="#文件说明">¶ </a>文件说明</h3><ol><li>8x10_msimage.mbn ----平台镜像，是个完整的最小系统启动镜像，包括 sbl，tz，sdi，rpm 等必要启动分区和分区表</li><li>MPRG8x10.hex ----对应平台的串口烧写协议</li><li>gpt_both0.bin ----对应 EMMC 的分区表，因为不同批次的 EMMC 大小有细微差别，这个分区表不包含最后一个分区信息</li><li>rawprogram0.xml ----要烧写的具体文件跟对应的扇区位置</li><li>patch0.xml ----刷机软件根据手机服务端返回的具体磁盘大小打上最后一个分区的补丁、完成分区表头校验的配置文件，没有正确的 patch0.xml 分区表头就不能通过校验，手机也启动不了</li></ol><p>8x10_msimage.mbn、MPRG8x10.hex 是通用的并可以在网上直接获取，单让手机进入磁盘模式，只需要 msimage 和 MPRG 即可。</p><h3 id="msimage-生成"><a class="header-anchor" href="#msimage-生成">¶ </a>msimage 生成</h3><p>生成自己的 msimage.mbn，在 msm7k 平台需要 MBR0.bin 和 <code>qcsblhd_cfgdata.mbn/qcsbl.mbn/oemsblhd.mbn/oemsbl.mbn</code> 或者完整的 <code>dbl/osbl</code>。</p><p>在 msm8k 平台后需要 gpt，<code>sbl1/sbl2/sbl3/rpm/tz</code>。并不建议自己生成 msimage，防止成真砖。</p><h4 id="win-未验证"><a class="header-anchor" href="#win-未验证">¶ </a>Win(未验证）</h4><p><a href="http://kernel-develop.blogspot.com/2012/05/how-to-generate-8660msimagembn.html" target="_blank" rel="external">How to generate the 8660_msimage.mbn</a><br><a href="http://kernel-develop.blogspot.com/2012/04/how-to-build-emmc-flash-programmer.html" target="_blank" rel="external"> How to build eMMC flash programmer MPRG7x30.hex and 7x30_msimage.mbn</a></p><p><code>emmcswdownload.exe -f 8660_msimage.mbn -x partition_boot.xml -s 16G</code></p><p>注意现在新版的 QPST，也只支持由 rawprogram0.xml 来生成 msimage 了。</p><h4 id="linux"><a class="header-anchor" href="#linux">¶ </a>Linux</h4><p><a href="http://kernel-develop.blogspot.com/2012/05/how-to-generate-7x30msimagembn.html" target="_blank" rel="external">How to generate the 7x30_msimage.mbn </a></p><p><code>python msp.py -r rawprogram0.xml -d 2048</code><br>生成 2048Kb，rawprogram0.xml 和其它一些文件如分区 mbr gpt 等是由上面所提到的 <a href="http://ptool.py" target="_blank" rel="external">ptool.py</a> 生成.这个 rawprogram0.xml 只需要包含生成 msimage 的必须项即可，可以手动直接修改，也可以修改 partition.xml，添加更多的启动分区命名成上面提到的 partition_boot.xml，然后再生成 rawprogram0.xml。</p><p>添加更多的分区，只要有该分区的镜像或者备份即可，比如包含 bootloader，这样有可能就可以直接启动到 bootloader 模式下刷机了，或者 NON-HLOS 等，或者一个完整的 rawprogram0.xml，这就相当于直接刷机了，但是这样生成的 msimage 将会非常大，刷起来非常的慢。</p><h2 id="edl-模式"><a class="header-anchor" href="#edl-模式">¶ </a>edl 模式</h2><p>就是常说的救砖模式，一般高通手机只要没有硬件问题,使用 QHSUSB DLOAD 模式一般都救的回来，使用的是高通的 sahara和 firehose 协议，是 msm8k 以后平台的协议标准，两种协议分别使用 eMMC Software Download 和 QFIL(Qualcomm Flash Image Loader) 刷机，这两个工具全部包括在高通的QPST中。在这两种协议下，在 9008 模式时烧写进去的大概只有五个文件，然后系统会进入 9006 模式，这个模式下系统会识别 qualcomm emmc 磁盘,此时就可以恢复各分区的备份，或者直接写入关键的系统分区备份(可以使用UltraISO/HDD Raw Copy Tools等工具)，这样就可以进入 recovery/bootloader 进行刷机，也可以使用 QFIL 或 Miflash 或 Msm8974 Download Tool等救砖工具一步完成。</p><p>在 msm7k 平台以前是没有 EDL 急救模式的，出了问题只能 JTAG。</p><p>备份的时候可以使用 dd 命令备份出整个磁盘，或者系统关键分区。或者使用<a href="http://4pda.ru/forum/index.php?showtopic=655617" target="_blank" rel="external">emmc raw tool</a></p><p>msimage MPRG 是 Sahara 协议下刷机的必需的，而 firehose 协议下的必须文件变成了 <code>prog_emmc_firehose_platform.mbn</code>，看文件就可以知道使用的是什么协议。而以前的例如 msm7k 平台有的使用的是 stream dload 协议，QPST 工具里面使用的是 Software Download，和 Sahara 协议相比，并不需要 msimage，也不需要 xml，只需要串口烧写协议如 <code>eNPRG hex</code> 和 <code>dbl/osbl</code>，实际上 Sahara 协议所使用的 msimage 刚好是 <code>dbl/osbl</code> 的结合体，so，<code>prog_emmc_firehose_platform.mbn</code>也是 msimage 和 MPRG hex 的结合体？</p><p>stream dload 协议救砖方法:</p><p><a href="http://kernel-develop.blogspot.com/2012/05/how-to-program-emmc-images-into-blank.html" target="_blank" rel="external">How to program eMMC images into blank flash with USB only in MSM7630 </a><br><a href="http://blog.csdn.net/fybon/article/details/18263191" target="_blank" rel="external"> qualcomm 8K平台Sahara Protocol相对7K, 6K 平台Software Download优点 </a></p><p>总结就是：8k Sahara Protocol省去了 CRC，打包、解包的过程直接传输 raw data，效率高。<br>同样的使用此模式刷机可以绕过华为的 MD5withRSA 的签名校验。</p><ul><li>一般手机都有特别的按键方式进入,例如 <code>vol+ &amp; usb</code> 等等</li><li>使用 <code>adb reboot edl</code> 或者 <code>adb reboot dload</code> 或者 <code>fastboot oem reboot-edl</code></li><li>清除tz分区 <code>cat /dev/zero &gt; /dev/block/platform/msm_sdcc.1/by-name/tz</code> 或者其它重要的分区如 sbl 分区、aboot 分区，也可在 fastboot 下直接 erase</li><li>当只能被识别为 9006 模式时，如果想切换到 9008，可以使用磁盘管理工具重建分区表，或者删除关键分区</li><li>拆机，短接测试点：把电信卡槽上面的金属片跟测试点连在一起，测试点要拆机才能看到（彻底黑砖的用这个方法）</li></ul><h2 id="qfil-command-line"><a class="header-anchor" href="#qfil-command-line">¶ </a>QFIL Command Line</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">qfil.exe -Mode=1 -COM="enter your comport number setting here" -SEARCHPATH="enter your complete path to 8675_W00 folder" -Sahara=true;"enter your complete path to the prog_emmc_FireHose_8936.mbn" -RawProgram=rawprogram0.xml -patch=patch0.xml -AckRawDataEveryNumPackets=TRUE;100 -DeviceTYPE="eMMC" -PlatForm="8x26" -MaxPayloadSizeToTargetInBytes="49152"</div><div class="line"></div><div class="line">Here are example to use it</div><div class="line"></div><div class="line">qfil.exe -Mode=1 -COM=64 -SEARCHPATH="D:\CBW8600A01_A_T1701" -Sahara=true;"D:\CBW8600A01_A_T1701\prog_emmc_FireHose_8x26.mbn" -RawProgram=rawprogram_unsparse.xml,rawprogram2.xml -patch=patch0,patch2.xml -AckRawDataEveryNumPackets=TRUE;100 -DeviceTYPE="eMMC" -PlatForm="8x26" -MaxPayloadSizeToTargetInBytes="49152"</div></pre></td></tr></table></figure><p><img src="http://forum.xda-developers.com/attachment.php?attachmentid=3261470&amp;stc=1&amp;d=1428998570" alt="参数参考"><br>更多文档在 QPST 软件的目录中。</p><h2 id="华为免解锁"><a class="header-anchor" href="#华为免解锁">¶ </a>华为免解锁</h2><p>官方卡刷跟官方平台线刷都会校验每个字节，每个文件，每个镜像文件都是 CRC32k 算法校验的，这是公开的。还有就是华为为防止文件的数据被修改还加了 MD5withRSA 加密算法，这个需要华为的私钥文件才能校验成功，私钥只有华为知道。</p><h3 id="解锁方法"><a class="header-anchor" href="#解锁方法">¶ </a>解锁方法</h3><ul><li>官方申请解锁码</li><li>将其它手机解完锁后的 oeminfo.img 写入 oeminfo 分区,进行强制解锁,但是IMEI之类的貌似就是别人的了</li><li>使用 edl 模式,刷入修改后的 oeminfo 分区镜像,或者直接修改 <code>echo -ne '\x02' | dd of=/dev/block/mmcblk0p3 bs=1 seek=33669144 conv=notrunc</code></li><li><a href="http://forum.xda-developers.com/showthread.php?t=2541843" target="_blank" rel="external">TUTORIAL: Remove <em>TAMPERED</em> &amp; <em>RELOCKED</em> flag </a></li><li><a href="http://www.in189.com/thread-1079000-1-1.html" target="_blank" rel="external">沃日，华为的解锁原理竟是如此的简单</a></li><li>十六个U是什么鬼,配合特定的机型,特定的 ROM 版本(efi fastboot),可实现解锁?</li></ul><p>华为的手机存在解锁后没法降级的情况,就算重新锁上也是不行的.可以 <code>dd if=/dev/urandom of=/dev/block/mmcblk0p8 bs=512 count=10</code> 向 oeminfo 分区写入随机数据(记得备份),重启后 bootloader 就会重新锁上，就可以自由升降级了。</p><h2 id="参考"><a class="header-anchor" href="#参考">¶ </a>参考</h2><ul><li><a href="http://blog.csdn.net/fybon/article/details/37565227" target="_blank" rel="external">高通 MSM8K bootloader</a></li><li><a href="http://www.in189.com/thread-1107257-1-1.html" target="_blank" rel="external">[教程] 高通平台线刷ROM制作简明教程，暴力ROOT</a></li><li><a href="http://blog.csdn.net/su_ky/article/details/7773273" target="_blank" rel="external">IM-A820L显示QHSUSB_DLOAD的救砖方案</a></li><li><a href="http://blog.csdn.net/ziyouwa/article/details/8620595" target="_blank" rel="external">A840S黑砖修复过程</a></li><li><a href="http://blog.csdn.net/benjaminwan/article/details/8854437" target="_blank" rel="external">泛泰SKYA850救砖原理与分区表解析</a></li><li><a href="http://blog.csdn.net/benjaminwan/article/details/8804647" target="_blank" rel="external">泛泰SKYA850黑砖QHSUSB_DLOAD救砖教程</a></li><li><a href="http://forum.xda-developers.com/showthread.php?t=2136738" target="_blank" rel="external">SHV-E160L Debricking Tool / Qualcomm Tool Pack V2-1</a></li><li><a href="http://forum.xda-developers.com/showthread.php?t=1978703" target="_blank" rel="external">[REF][R&amp;D] Building Bootloaders on Qualcomm Devices</a></li><li><a href="http://forum.xda-developers.com/showthread.php?t=2086142" target="_blank" rel="external">[R&amp;D][QUALCOMM] Using QDL, EHostDL and DIAG interfaces &amp; features</a></li><li><a href="http://forum.xda-developers.com/yureka/help/question-qualcomm-download-mode-k-t3068040" target="_blank" rel="external">[PROJECT] Reviving Hard Bricked YU (QLoader 9008 Mode)</a></li><li><a href="http://forum.xda-developers.com/mi-2/orig-development/flashtools-miflash4linux-recovery-qdl-t3036730" target="_blank" rel="external">Flashtools (MiFlash4Linux, Recovery from QDL/DLOAD, Partition resize)</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;生成所需xml&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#生成所需xml&quot;&gt;¶ &lt;/a&gt;生成所需xml&lt;/h2&gt;
&lt;h3 id=&quot;gpt-分区-parse-gpt&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#gpt-分区-parse-gpt&quot;&gt;¶ &lt;/a&gt;GPT 分区 parse_gpt&lt;/h3&gt;
&lt;p&gt;根据官方 GPT 文件解析出具体的 GPT 的分区信息并生成对应平台的 partiiton.xml 文件，最后通过 &lt;a href=&quot;http://ptool.py&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;ptool.py&lt;/a&gt; 生成可刷写的配置文件 rawprogram0.xml、patch0.xml 跟最后的 GPT。&lt;/p&gt;
&lt;p&gt;官方的 gpt 文件一般需要经过裁剪,一般裁剪成 17408 字节大小，包括文件头开始的 512 字节的 MBR 信息 &lt;code&gt;dd if=gpt.bin of=gpt-new.bin bs=17408 count=1&lt;/code&gt;,然后使用 &lt;code&gt;./parse_gpt gpt-new.bin&lt;/code&gt;，输出在 &lt;code&gt;GPT_DUNP_FILES&lt;/code&gt; 中。&lt;/p&gt;
&lt;p&gt;或者在手机中 &lt;code&gt;dd if=/dev/block/mmcblk0 of=/sdcard/gpt-new.bin bs=17408 count=1&lt;/code&gt;，为配合 parse_gpt,大小一般为 17408/34304。&lt;/p&gt;
    
    </summary>
    
      <category term="Android" scheme="http://blog.omitol.com/categories/Android/"/>
    
    
      <category term="EDL" scheme="http://blog.omitol.com/tags/EDL/"/>
    
      <category term="DLOAD" scheme="http://blog.omitol.com/tags/DLOAD/"/>
    
  </entry>
  
  <entry>
    <title>2015夏稻城亚丁</title>
    <link href="http://blog.omitol.com/2015/07/11/yading/"/>
    <id>http://blog.omitol.com/2015/07/11/yading/</id>
    <published>2015-07-10T16:00:00.000Z</published>
    <updated>2017-10-15T11:43:19.106Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://i.imgur.com/jtmdfPZ.jpg" alt="仙乃日神山"></p><blockquote><p>稻城亚丁仙乃日神山，摄于2015年夏318之行</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;http://i.imgur.com/jtmdfPZ.jpg&quot; alt=&quot;仙乃日神山&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;稻城亚丁仙乃日神山，摄于2015年夏318之行&lt;/p&gt;
&lt;/blockquote&gt;

      
    
    </summary>
    
      <category term="相册" scheme="http://blog.omitol.com/categories/%E7%9B%B8%E5%86%8C/"/>
    
    
  </entry>
  
  <entry>
    <title>OpenWrt-x86 笔记</title>
    <link href="http://blog.omitol.com/2015/03/09/openwrt-x86-note/"/>
    <id>http://blog.omitol.com/2015/03/09/openwrt-x86-note/</id>
    <published>2015-03-08T16:00:00.000Z</published>
    <updated>2017-10-12T03:10:18.327Z</updated>
    
    <content type="html"><![CDATA[<p>此乃 OpenWrt-x86 编译时的笔记，很乱、不够系统，但以后完善</p><h2 id="目标硬件"><a class="header-anchor" href="#目标硬件">¶ </a>目标硬件</h2><ul><li>Intel NUC D34010WYK</li><li>4g 内存</li><li>60g SSD</li><li>Intel N2230无线网卡</li></ul><h2 id="x86-编译注意事项"><a class="header-anchor" href="#x86-编译注意事项">¶ </a>x86 编译注意事项</h2><ul><li>大内存支持</li><li>多核心，多线程支持</li><li>sata drive 支持</li><li>网卡、wifi 驱动的集成</li><li>对 usb，例如鼠标、键盘的支持</li><li>编译所有文件系统支持，包括 ext2/ext3/ext4，还有 NTFS，甚至是 LVM；</li><li>加入一个文本编辑器，例如 vim 或者 nano，因为日常使用中需要用文本编辑器修改各种配置文件；</li><li>加入所有关于无线网卡的驱动，模块，各种支持程序，</li><li>一些其他常见应用–蓝牙、加密、PGP、SSL、SSH、VPN、USB支持、3G上网卡</li></ul><a id="more"></a><h2 id="convert-openwrt-raw-image"><a class="header-anchor" href="#convert-openwrt-raw-image">¶ </a>Convert OpenWrt raw image</h2><ol><li><code>gunzip openwrt.img.gz</code></li><li><code>VBoxManage convertfromraw --format VDI openwrt.img openwrt.vdi</code></li></ol><h2 id="compile"><a class="header-anchor" href="#compile">¶ </a>Compile</h2><pre><code>make menuconfigmake kernel_menuconfig</code></pre><h2 id="真机使用注意事项"><a class="header-anchor" href="#真机使用注意事项">¶ </a>真机使用注意事项</h2><ul><li>在 bios 中对 ide、sata 的修改</li></ul><h2 id="编译流程"><a class="header-anchor" href="#编译流程">¶ </a>编译流程</h2><h3 id="流程"><a class="header-anchor" href="#流程">¶ </a>流程</h3><ol><li><code>./scripts/feeds update -a</code></li><li><code>./scripts/feeds install -a</code></li><li>检查编译环境，若可进行编译则生成默认配置 <code>make defconfig</code></li><li><code>make menuconfig</code> 若有需求，则可以 <code>make kernel_menuconfig</code></li><li><code>make -j32 V=99</code>，编译过程中会联网下载一些 package</li></ol><p>编译完成的文件，在 bin/x86 目录下，可以烧写到U盘中测试。</p><ul><li><a href="http://wiki.openwrt.org/doc/howto/build" target="_blank" rel="external">how to build</a></li></ul><h3 id="单独编译某个包"><a class="header-anchor" href="#单独编译某个包">¶ </a>单独编译某个包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">make packages/xxx/clean</div><div class="line">make packages/xxx/compile</div><div class="line">make packages/xxx/install</div></pre></td></tr></table></figure><h2 id="未完成的工作"><a class="header-anchor" href="#未完成的工作">¶ </a>未完成的工作</h2><ul><li><p>配置 wifi 热点的自动开启</p></li><li><p>音频、视频的支持</p></li><li><p>电源键的支持</p></li><li><p>U盘的自动挂载</p></li><li><p>3g/4g 上网卡的支持</p></li><li><p>对 sata 的支持</p></li><li><p><a href="http://lotors.me/2014/08/16/opcompilepro/" target="_blank" rel="external">编译过程和后期的一些配置参考</a></p></li></ul><h2 id="gargoyle-的编译"><a class="header-anchor" href="#gargoyle-的编译">¶ </a>Gargoyle 的编译</h2><h3 id="如果有目标硬件"><a class="header-anchor" href="#如果有目标硬件">¶ </a>如果有目标硬件</h3><p><code>make FULL_BUILD=ture brcm47xx</code><br><code>make brcm47xx</code> 是rebuild</p><h3 id="自由定制"><a class="header-anchor" href="#自由定制">¶ </a>自由定制</h3><p><code>make custom</code>，上述命令会自动调用 <code>make menuconfig</code>配置菜单，但是第二次执行时就会跳过配置界面，所以要<code>make FULL_BUILD=true custom</code></p><h2 id="首次配置的方法"><a class="header-anchor" href="#首次配置的方法">¶ </a>首次配置的方法</h2><p>设备成功启动后，连接到该 AP 上，telnet 到 <code>192.168.1.1</code>,输入 <code>passwd</code>，设置密码后，才能使用 ssh 登陆，然后配置网络即可。如果设备启动失败，只有连接显示器查看原因了。</p><hr><h2 id="一些软件的安装"><a class="header-anchor" href="#一些软件的安装">¶ </a>一些软件的安装</h2><h3 id="安装-luci"><a class="header-anchor" href="#安装-luci">¶ </a>安装 luci</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">opkg update</div><div class="line">opkg intsall luci</div><div class="line">安装完毕记得启动luci</div><div class="line">./etc/init.d/uhttpd enable</div><div class="line">./etc/init.d/uhttpd start</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">opkg install kmod-usb-core</div><div class="line">opkg install kmod-usb-ohci          #安装usb ohci控制器驱动</div><div class="line">opkg install kmod-usb-uhci     　#UHCI　USB控制器</div><div class="line">opkg install kmod-usb2                #安装usb2.0</div><div class="line">opkg install kmod-usb-storage     #安装usb存储设备驱动</div><div class="line">opkg install kmod-fs-ext3              #安装ext3分区格式支持组件</div><div class="line">opkg install mount-utils                #挂载卸载工具</div><div class="line">opkg install ntfs-3g                      #挂载NTFS</div><div class="line">opkg install kmod-fs-vfat              #挂载FAT</div><div class="line">opkg install block-mount</div><div class="line">opkg install fdisk    </div><div class="line">opkg install usbutils #安装了这个后可以用 lsusb</div><div class="line">opkg install pciutils</div></pre></td></tr></table></figure><h2 id="具体配置"><a class="header-anchor" href="#具体配置">¶ </a>具体配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">Target System (x86)    #目标平台选择,这里选择X86，如果非x86系统下面需要选择</div><div class="line">TargetImages  ---&gt;</div><div class="line">ext4    #生成.EXT4.IMG文件</div><div class="line">[0] seconds to wait befor booting the default entry  #启动不等待5秒</div><div class="line">Base system  ---&gt;</div><div class="line">&lt;*&gt; block-mount  #以后挂载USB用</div><div class="line">kernel modules  ---&gt;</div><div class="line">    Block Devices ---&gt;       这项用于支持磁盘</div><div class="line">        &lt;*&gt; kmod-ata-core    #支持SATA硬盘</div><div class="line">        &lt;*&gt;   kmod-ata-ahci  </div><div class="line">        &lt;*&gt; kmod-loop</div><div class="line">    Filesystems  ---&gt;</div><div class="line">        &lt;*&gt; kmod-fs-ext4   </div><div class="line">    NativeLanguage Support  ---&gt;   #语言支持</div><div class="line">        &lt;*&gt; kmod-nls-iso8859-1</div><div class="line">        &lt;*&gt; kmod-nls-utf8</div><div class="line">    Network Devices  ---&gt;   #网卡驱动，必须添加自己需要的网卡驱动</div><div class="line">        &lt;*&gt; kmod-macvlan  </div><div class="line">    Wireless Drivers  ---&gt; #wifi卡驱动，添加自己需要的</div><div class="line">Luci-----</div><div class="line">Collection----luci</div><div class="line">Translation---luci-i18n-chinese</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Input modules  ---&gt;#键盘</div><div class="line">         -*- kmod-hid</div><div class="line">         &lt;*&gt; kmod-hid-generic</div><div class="line">         -*- kmod-input-core</div><div class="line">         -*- kmod-input-evdev</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Kernel modules:</div><div class="line">    USB Support:</div><div class="line">        &lt;*&gt; Kmod-usb-storage</div><div class="line">    Filesystems:</div><div class="line">        &lt;*&gt; Kmod-fs-ext3</div><div class="line">Base system:</div><div class="line">    &lt;*&gt; Block-extroot</div><div class="line">Utilities:</div><div class="line">    Filesystem:</div><div class="line">        &lt;*&gt; E2fsprogs</div><div class="line">    Disc:</div><div class="line">        &lt;*&gt; Fdisk &gt;</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Processor type and features  ---&gt;</div><div class="line">    [*] Symmetric multi-processing support</div><div class="line">    Processor family (Core 2/newer Xeon)  ---&gt;#自行选择处理器平台</div><div class="line">    [*] Supported processor vendors  ---&gt;#自行选择处理器平台</div><div class="line">    (2) Maximum number of CPUs #自行编辑</div><div class="line">    [*] SMT (Hyperthreading) scheduler support#超线程支持</div><div class="line">    [*] Multi-core scheduler support </div><div class="line">    High Memory Support (4GB)  ---&gt;</div></pre></td></tr></table></figure><p>若使用U盘测试，还需配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Target Images  ---&gt; </div><div class="line">    (/dev/sda2) Root partition on target device (NEW) #修改 /dev/sda2 为 /dev/sdb2</div></pre></td></tr></table></figure><hr><h2 id="对-freeswitch-的集成"><a class="header-anchor" href="#对-freeswitch-的集成">¶ </a>对 freeswitch 的集成</h2><p>目前的两种方法</p><ol><li>直接把 freeswitch 的源码目录放到 openwrt 的 package 目录中，</li><li>做为一个单独的 git 项目，使用该 package 时修改 <code>feeds.conf</code> 添加订阅，然后在 <code>make menuconfig</code> 时选择 freeswitch 模块。</li></ol><p>无论这两种方法，都需要在 freeswith 中增加</p><ul><li>package/Makefile [必备]</li><li>package/patches/ [可选]</li><li>package/files/ [可选]</li></ul><p>patches 目录和files 目录都是可选的，patches 目录通常包括 bug 修复和对可执行文件体积的优化，files 目录通常包括配置文件。</p><h3 id="makefile文件"><a class="header-anchor" href="#makefile文件">¶ </a>Makefile文件</h3><ul><li>PKG_NAME -软件包的名字, 在 menuconfig 和 ipkg 显示</li><li>PKG_VERSION -软件包的版本，主干分支的版本正是我们要下载的</li><li>PKG_RELEASE -这个 makefile 的版本</li><li>PKG_BUILD_DIR -编译软件包的目录</li><li>PKG_SOURCE -要下载的软件包的名字，一般是由 PKG_NAME 和 PKG_VERSION 组成</li><li>PKG_SOURCE_URL -下载这个软件包的链接</li><li>PKG_MD5SUM -软件包的 MD5 值</li><li>PKG_CAT -解压软件包的方法 (zcat, bzcat, unzip)</li><li>PKG_BUILD_DEPENDS -需要预先构建的软件包，但只是在构建本软件包时，而不是运行的的语法和下面的 DEPENDS 一样。</li></ul><h3 id="参考"><a class="header-anchor" href="#参考">¶ </a>参考</h3><ul><li><a href="http://wiki.openwrt.org/zh-cn/doc/devel/packages" target="_blank" rel="external">创建软件包</a></li><li><a href="http://wiki.freeswitch.org/wiki/OpenWrt" target="_blank" rel="external">configure FreeSWITCH to run on their OpenWrt</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;此乃 OpenWrt-x86 编译时的笔记，很乱、不够系统，但以后完善&lt;/p&gt;
&lt;h2 id=&quot;目标硬件&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#目标硬件&quot;&gt;¶ &lt;/a&gt;目标硬件&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Intel NUC D34010WYK&lt;/li&gt;
&lt;li&gt;4g 内存&lt;/li&gt;
&lt;li&gt;60g SSD&lt;/li&gt;
&lt;li&gt;Intel N2230无线网卡&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;x86-编译注意事项&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#x86-编译注意事项&quot;&gt;¶ &lt;/a&gt;x86 编译注意事项&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;大内存支持&lt;/li&gt;
&lt;li&gt;多核心，多线程支持&lt;/li&gt;
&lt;li&gt;sata drive 支持&lt;/li&gt;
&lt;li&gt;网卡、wifi 驱动的集成&lt;/li&gt;
&lt;li&gt;对 usb，例如鼠标、键盘的支持&lt;/li&gt;
&lt;li&gt;编译所有文件系统支持，包括 ext2/ext3/ext4，还有 NTFS，甚至是 LVM；&lt;/li&gt;
&lt;li&gt;加入一个文本编辑器，例如 vim 或者 nano，因为日常使用中需要用文本编辑器修改各种配置文件；&lt;/li&gt;
&lt;li&gt;加入所有关于无线网卡的驱动，模块，各种支持程序，&lt;/li&gt;
&lt;li&gt;一些其他常见应用–蓝牙、加密、PGP、SSL、SSH、VPN、USB支持、3G上网卡&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="Openwrt" scheme="http://blog.omitol.com/categories/Openwrt/"/>
    
    
      <category term="Openwrt-x86" scheme="http://blog.omitol.com/tags/Openwrt-x86/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu 12.04 安装搜狗拼音输入法</title>
    <link href="http://blog.omitol.com/2014/05/19/ubuntu12.04-install-sogoupinyin/"/>
    <id>http://blog.omitol.com/2014/05/19/ubuntu12.04-install-sogoupinyin/</id>
    <published>2014-05-19T07:53:41.000Z</published>
    <updated>2017-09-30T19:12:01.000Z</updated>
    
    <content type="html"><![CDATA[<p>新出的linux下的搜狗输入法，颇感兴趣，这里作为记录。</p><h3 id="安装fcitx"><a class="header-anchor" href="#安装fcitx">¶ </a>安装fcitx</h3><p>ubuntu12.04默认源中的fcitx版本较旧，安装新版本的fcitx。</p><pre><code>sudo add-apt-repository ppa:fcitx-team/nightlysudo apt-get update </code></pre><p>如果已经安装了旧版本的fctix，更新:</p><pre><code>sudo apt-get upgrade </code></pre><a id="more"></a><p>更新后，需重启或注销重新登陆。</p><p>未安装，直接安装：</p><pre><code>sudo apt-get install fcitx</code></pre><p>安装googlepinyin和sunpinyin（个人习惯，作为备用）：</p><pre><code>sudo apt-get install fcitx-googlepinyinsudo apt-get install fcitx-sunpinyin</code></pre><p>切换输入法框架为fcitx：</p><pre><code>im-switch -s fcitx </code></pre><h3 id="卸载ibus"><a class="header-anchor" href="#卸载ibus">¶ </a>卸载ibus</h3><p>ibus和fcitx共存时老有一些莫名其妙的bug，所以卸载ibus。</p><pre><code>killall ibus-daemonsudo apt-get autoremove ibus ibus-sunpinyin</code></pre><p>如果你使用的桌面是gnome，请暂时先不要卸载ibus-gtk3，据说会导致进步了系统。</p><p>如果上一步没有重启过，重启或者注销重新登陆。</p><h3 id="安装搜狗拼音"><a class="header-anchor" href="#安装搜狗拼音">¶ </a>安装搜狗拼音</h3><ul><li><a href="http://pinyin.sogou.com/linux/?r=pinyin" target="_blank" rel="external">下载安装</a></li></ul><h3 id="遇到的问题"><a class="header-anchor" href="#遇到的问题">¶ </a>遇到的问题</h3><p>小企鹅右键设置启用搜狗pinyin，输入的时候提示：</p><blockquote><p>請啓用fcitx-qimpanel面板程序，以便更好的享受搜狗輸入法！</p></blockquote><p>解决办法：<br>重启 fcitx 切换到 qimpanel，同时开启 qimpanel</p><pre><code>fcitx -r --enable fcitx-qimpanelfcitx-qimpanel </code></pre><p>有时重启系统后，输入法没有输入框的现象，只能盲打，我的解决办法是kill掉fcitx-qimpanel，然后重新启动，不可以的话就多kill掉几次<code>ps -ef | grep qim</code>。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;新出的linux下的搜狗输入法，颇感兴趣，这里作为记录。&lt;/p&gt;
&lt;h3 id=&quot;安装fcitx&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#安装fcitx&quot;&gt;¶ &lt;/a&gt;安装fcitx&lt;/h3&gt;
&lt;p&gt;ubuntu12.04默认源中的fcitx版本较旧，安装新版本的fcitx。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;sudo add-apt-repository ppa:fcitx-team/nightly
sudo apt-get update 
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;如果已经安装了旧版本的fctix，更新:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;sudo apt-get upgrade 
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="Ubuntu" scheme="http://blog.omitol.com/categories/Ubuntu/"/>
    
    
      <category term="输入法" scheme="http://blog.omitol.com/tags/%E8%BE%93%E5%85%A5%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>Sublime_text 支持中文输入</title>
    <link href="http://blog.omitol.com/2014/05/19/sublime-support-chinese-im/"/>
    <id>http://blog.omitol.com/2014/05/19/sublime-support-chinese-im/</id>
    <published>2014-05-19T02:53:41.000Z</published>
    <updated>2017-09-30T19:12:18.000Z</updated>
    
    <content type="html"><![CDATA[<p>让sublime_text支持中文输入，这在ubuntu上是一直不可以的，以前用过插件来达到中文你输入的目的，不过太繁琐。</p><h3 id="安装编译所需依赖"><a class="header-anchor" href="#安装编译所需依赖">¶ </a>安装编译所需依赖</h3><p><code>sudo apt-get install build-essential libgtk2.0-dev</code></p><a id="more"></a><h3 id="源代码"><a class="header-anchor" href="#源代码">¶ </a>源代码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">sublime-imfix.c</span></div><div class="line"><span class="comment">Use LD_PRELOAD to interpose some function to fix sublime input method support for linux.</span></div><div class="line"><span class="comment">By Cjacker Huang &lt;jianzhong.huang at i-soft.com.cn&gt;</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">gcc -shared -o libsublime-imfix.so sublime_imfix.c  `pkg-config --libs --cflags gtk+-2.0` -fPIC</span></div><div class="line"><span class="comment">LD_PRELOAD=./libsublime-imfix.so sublime_text</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;gtk/gtk.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;gdk/gdkx.h&gt;</span></span></div><div class="line"><span class="keyword">typedef</span> GdkSegment GdkRegionBox;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">GdkRegion</span></span></div><div class="line"><span class="class">&#123;</span></div><div class="line">  <span class="keyword">long</span> size;</div><div class="line">  <span class="keyword">long</span> numRects;</div><div class="line">  GdkRegionBox *rects;</div><div class="line">  GdkRegionBox extents;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">GtkIMContext *local_context;</div><div class="line"></div><div class="line"><span class="keyword">void</span></div><div class="line">gdk_region_get_clipbox (<span class="keyword">const</span> GdkRegion *region,</div><div class="line">            GdkRectangle    *rectangle)</div><div class="line">&#123;</div><div class="line">  g_return_if_fail (region != <span class="literal">NULL</span>);</div><div class="line">  g_return_if_fail (rectangle != <span class="literal">NULL</span>);</div><div class="line"></div><div class="line">  rectangle-&gt;x = region-&gt;extents.x1;</div><div class="line">  rectangle-&gt;y = region-&gt;extents.y1;</div><div class="line">  rectangle-&gt;width = region-&gt;extents.x2 - region-&gt;extents.x1;</div><div class="line">  rectangle-&gt;height = region-&gt;extents.y2 - region-&gt;extents.y1;</div><div class="line">  GdkRectangle rect;</div><div class="line">  rect.x = rectangle-&gt;x;</div><div class="line">  rect.y = rectangle-&gt;y;</div><div class="line">  rect.width = <span class="number">0</span>;</div><div class="line">  rect.height = rectangle-&gt;height;</div><div class="line">  <span class="comment">//The caret width is 2;</span></div><div class="line">  <span class="comment">//Maybe sometimes we will make a mistake, but for most of the time, it should be the caret.</span></div><div class="line">  <span class="keyword">if</span>(rectangle-&gt;width == <span class="number">2</span> &amp;&amp; GTK_IS_IM_CONTEXT(local_context)) &#123;</div><div class="line">        gtk_im_context_set_cursor_location(local_context, rectangle);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//this is needed, for example, if you input something in file dialog and return back the edit area</span></div><div class="line"><span class="comment">//context will lost, so here we set it again.</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> GdkFilterReturn <span class="title">event_filter</span> <span class="params">(GdkXEvent *xevent, GdkEvent *event, gpointer im_context)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    XEvent *xev = (XEvent *)xevent;</div><div class="line">    <span class="keyword">if</span>(xev-&gt;type == KeyRelease &amp;&amp; GTK_IS_IM_CONTEXT(im_context)) &#123;</div><div class="line">       GdkWindow * win = g_object_get_data(G_OBJECT(im_context),<span class="string">"window"</span>);</div><div class="line">       <span class="keyword">if</span>(GDK_IS_WINDOW(win))</div><div class="line">         gtk_im_context_set_client_window(im_context, win);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> GDK_FILTER_CONTINUE;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">gtk_im_context_set_client_window</span> <span class="params">(GtkIMContext *context,</span></span></div><div class="line"><span class="function"><span class="params">          GdkWindow    *window)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  GtkIMContextClass *klass;</div><div class="line">  g_return_if_fail (GTK_IS_IM_CONTEXT (context));</div><div class="line">  klass = GTK_IM_CONTEXT_GET_CLASS (context);</div><div class="line">  <span class="keyword">if</span> (klass-&gt;set_client_window)bbbbbbbb</div><div class="line">    klass-&gt;set_client_window (context, window);</div><div class="line"></div><div class="line">  <span class="keyword">if</span>(!GDK_IS_WINDOW (window))</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  g_object_set_data(G_OBJECT(context),<span class="string">"window"</span>,window);</div><div class="line">  <span class="keyword">int</span> width = gdk_window_get_width(window);</div><div class="line">  <span class="keyword">int</span> height = gdk_window_get_height(window);</div><div class="line">  <span class="keyword">if</span>(width != <span class="number">0</span> &amp;&amp; height !=<span class="number">0</span>) &#123;</div><div class="line">    gtk_im_context_focus_in(context);</div><div class="line">    local_context = context;</div><div class="line">  &#125;</div><div class="line">  gdk_window_add_filter (window, event_filter, context);</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="编译"><a class="header-anchor" href="#编译">¶ </a>编译</h3><p><code>gcc -shared -o libsublime-imfix.so sublime_imfix.c</code>pkg-config --libs --cflags gtk±2.0<code>-fPIC</code></p><h3 id="启动sublime"><a class="header-anchor" href="#启动sublime">¶ </a>启动sublime</h3><p><code>LD_PRELOAD=./libsublime-imfix.so subl</code></p><h3 id="添加到默认启动"><a class="header-anchor" href="#添加到默认启动">¶ </a>添加到默认启动</h3><p>查看sublime-text所在文件夹：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">which subl</div><div class="line">vi /usr/bin/subl</div></pre></td></tr></table></figure><p>复制libsublime-imfix.so到sublime所在文件夹：<br><code>sudo cp libsublime-imfix.so /opt/sublime_text</code></p><h4 id="方法一"><a class="header-anchor" href="#方法一">¶ </a>方法一</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cd /usr/bin/</div><div class="line">sudo touch sublime_text3 </div><div class="line">sudo chmod a+x sublime_text3</div><div class="line">sudo vi sublime_text3</div></pre></td></tr></table></figure><p>添加内容：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span>!/bin/bash</div><div class="line">SUBLIME_HOME="/opt/sublime_text"</div><div class="line">LD_LIB=$SUBLIME_HOME/libsublime-imfix.so</div><div class="line">sh -c "LD_PRELOAD=$LD_LIB $SUBLIME_HOME/sublime_text $@"</div></pre></td></tr></table></figure><p>保存退出。</p><p>编辑<code>/usr/share/applications</code>将其中的三处<code>/opt/sublime_text/sublime_text</code>修改为<code>/usr/bin/sublime_text3</code>。</p><p>这样无论在终端中执行<code>sublime_text3</code>还是双击或者右键打开文本都可以输入中文了。</p><h4 id="方法二"><a class="header-anchor" href="#方法二">¶ </a>方法二</h4><p>编辑<code>/usr/bin/subl</code>，在最后一行上面添加：<br><code>export LD_PRELOAD=/opt/sublime_text/libsublime-imfix.so</code></p><p>编辑<code>/usr/share/applications</code>将其中的三处<code>/opt/sublime_text/sublime_text</code>替换为<code>/usr/bin/subl</code></p><h3 id="参考"><a class="header-anchor" href="#参考">¶ </a>参考</h3><ul><li><a href="http://www.sublimetext.com/forum/viewtopic.php?f=3&amp;t=7006&amp;start=10#p41343" target="_blank" rel="external">Input method support</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;让sublime_text支持中文输入，这在ubuntu上是一直不可以的，以前用过插件来达到中文你输入的目的，不过太繁琐。&lt;/p&gt;
&lt;h3 id=&quot;安装编译所需依赖&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#安装编译所需依赖&quot;&gt;¶ &lt;/a&gt;安装编译所需依赖&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;sudo apt-get install build-essential libgtk2.0-dev&lt;/code&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Tools" scheme="http://blog.omitol.com/categories/Tools/"/>
    
    
      <category term="Sublime text" scheme="http://blog.omitol.com/tags/Sublime-text/"/>
    
  </entry>
  
  <entry>
    <title>搭建 Jenkins 编译 nightly version rom</title>
    <link href="http://blog.omitol.com/2014/04/22/jekins_CI_build_rom/"/>
    <id>http://blog.omitol.com/2014/04/22/jekins_CI_build_rom/</id>
    <published>2014-04-21T16:00:00.000Z</published>
    <updated>2017-09-27T13:20:18.000Z</updated>
    
    <content type="html"><![CDATA[<p>使用CI(持续集成)jekins编译nightly版的ROM</p><h3 id="安装apache"><a class="header-anchor" href="#安装apache">¶ </a>安装apache</h3><pre><code>sudo apt-get install apache2 </code></pre><h3 id="安装jenkins"><a class="header-anchor" href="#安装jenkins">¶ </a>安装jenkins</h3><p>切换到root用户下:</p><pre><code>echo deb http://pkg.jenkins-ci.org/debian binary/ &gt; /etc/apt/sources.list.d/jenkins.list </code></pre><p>切回用户:</p><pre><code>apt-get update &amp;&amp; apt-get install jenkins </code></pre><a id="more"></a><h3 id="其它"><a class="header-anchor" href="#其它">¶ </a>其它</h3><p>重启服务命令:</p><pre><code>/etc/init.d/jenkins restart </code></pre><p>安装完成后,系统中添加了一个用户jenkins,不要尝试修改该用户的密码.</p><p><code>/var/lib/jenkins</code>下面的文件都是jenkins用户的,对jenkins来说,这个目录就是它的home目录,所以修改这个下面的文件时注意文件的拥有者.</p><pre><code>sudo su - jenkins </code></pre><p>可以切换到该用户.</p><p>访问<code>localhost:8080</code>,首先要做的就是添加一个用户所用权限的用户，然后使用该用户sign up。</p><p>jenkins的配置文件在<code>/etc/default/jenkins</code>.</p><h3 id="setting-up-the-job"><a class="header-anchor" href="#setting-up-the-job">¶ </a>Setting up the job</h3><p>To use Jenkins to build regular nightlies for multiple devices, follow this quick steps:</p><ul><li>Prepare your Android source tree</li><li>Create a new job, as a multi-configuration project</li><li>In Advanced Project Options, check “Custom workspace”, and point both the Directory and Directory for sub-builds to the root of your Android tree</li><li>Add a new user-defined axis to the matrix, and call it ‘device’. In values, you must put each device you want to build, separated by spaces (e.g. ‘mako manta flo deb’).</li><li>Check ‘Run each configuration sequentially’</li><li>Add a new ‘Execute shell’ build step, in order to run a short build script. In Omni’s case we have a script at the root of our workspace, thus we put ‘./build_nightly.sh $device’, where $device will be replaced by each device for each build.</li><li>Save the job, you’re all set.</li></ul><p>Create then your build script. Here’s Omni build script:</p><pre><code>#!/bin/bashexport USE_CCACHE=1export CCACHE_DIR=/home/build/.ccacheexport BUILDTYPE_NIGHTLY=1DEVICE=$*cd /home/build/omni. build/envsetup.shrepo sync -j48rm -rf out/targetbrunch $DEVICE</code></pre><h3 id="adding-a-device-to-a-nightly-job"><a class="header-anchor" href="#adding-a-device-to-a-nightly-job">¶ </a>Adding a device to a nightly job</h3><p>Just add the device code into the ‘device’ axis in the job settings.</p><h3 id="遇到的问题"><a class="header-anchor" href="#遇到的问题">¶ </a>遇到的问题</h3><p>当脚本被触发运行时,使用的jenkins用户的环境变量,会出现找不到环境变量,和许多的权限问题.最后的解决方法是,新建一个节点,指向本机IP和workspace,以ssh登录即可.</p><h3 id="参考"><a class="header-anchor" href="#参考">¶ </a>参考</h3><ul><li><a href="http://docs.omnirom.org/Setting_up_Jenkins_for_building_nightlies" target="_blank" rel="external">Setting up Jenkins for building nightlies</a></li><li><a href="http://forum.xda-developers.com/showthread.php?t=2467004" target="_blank" rel="external">HOW TO AUTOMATE YOUR ROM BUILDING PROCESS</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;使用CI(持续集成)jekins编译nightly版的ROM&lt;/p&gt;
&lt;h3 id=&quot;安装apache&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#安装apache&quot;&gt;¶ &lt;/a&gt;安装apache&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;sudo apt-get install apache2 
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;安装jenkins&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#安装jenkins&quot;&gt;¶ &lt;/a&gt;安装jenkins&lt;/h3&gt;
&lt;p&gt;切换到root用户下:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;echo deb http://pkg.jenkins-ci.org/debian binary/ &amp;gt; /etc/apt/sources.list.d/jenkins.list 
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;切回用户:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apt-get update &amp;amp;&amp;amp; apt-get install jenkins 
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="Tools" scheme="http://blog.omitol.com/categories/Tools/"/>
    
    
      <category term="Jenkins" scheme="http://blog.omitol.com/tags/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>将 Sublime Text 2 设置为默认编辑器</title>
    <link href="http://blog.omitol.com/2013/11/22/set-sublimetext-to-default-editor/"/>
    <id>http://blog.omitol.com/2013/11/22/set-sublimetext-to-default-editor/</id>
    <published>2013-11-21T16:00:00.000Z</published>
    <updated>2017-09-27T13:20:18.000Z</updated>
    
    <content type="html"><![CDATA[<p>虽然一直在用Sublime Text 2，但是一直比较懒，没有将其设置为默认编辑器。</p><h3 id="修改defaults-list"><a class="header-anchor" href="#修改defaults-list">¶ </a>修改defaults.list</h3><p>编辑<code>/etc/gnome/default.list</code>文件，将其中的所有<code>gedit.desktop</code>替换为<code>sublime-text-2.desktop</code>。</p><p>sublime-text-2.desktop在<code>/usr/share/applications/</code>目录下，使用<code>ls -al *sublime*</code>命令查看具体文件名。</p><a id="more"></a><h3 id="配置alternatives"><a class="header-anchor" href="#配置alternatives">¶ </a>配置alternatives</h3><p>执行：</p><pre><code>sudo update-alternatives --install /usr/bin/gnome-text-editor gnome-text-editor /usr/bin/sublime-text 300</code></pre><p>sublime-text在/usr/bin目录下，是一个可执行二进制文件。<br>然后：</p><pre><code>sudo update-alternatives --config gnome-text-editor</code></pre><p>输入sublime-text那一行的行数就行了。</p><p>OK!</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;虽然一直在用Sublime Text 2，但是一直比较懒，没有将其设置为默认编辑器。&lt;/p&gt;
&lt;h3 id=&quot;修改defaults-list&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#修改defaults-list&quot;&gt;¶ &lt;/a&gt;修改defaults.list&lt;/h3&gt;
&lt;p&gt;编辑&lt;code&gt;/etc/gnome/default.list&lt;/code&gt;文件，将其中的所有&lt;code&gt;gedit.desktop&lt;/code&gt;替换为&lt;code&gt;sublime-text-2.desktop&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;sublime-text-2.desktop在&lt;code&gt;/usr/share/applications/&lt;/code&gt;目录下，使用&lt;code&gt;ls -al *sublime*&lt;/code&gt;命令查看具体文件名。&lt;/p&gt;
    
    </summary>
    
      <category term="Tools" scheme="http://blog.omitol.com/categories/Tools/"/>
    
    
      <category term="Sublime text" scheme="http://blog.omitol.com/tags/Sublime-text/"/>
    
  </entry>
  
  <entry>
    <title>编译极路由的 OpenWRT 固件</title>
    <link href="http://blog.omitol.com/2013/11/12/openwrt-for-hiwifi/"/>
    <id>http://blog.omitol.com/2013/11/12/openwrt-for-hiwifi/</id>
    <published>2013-11-11T16:00:00.000Z</published>
    <updated>2017-09-27T13:20:18.000Z</updated>
    
    <content type="html"><![CDATA[<p>虽然被坑了，看习惯了塑料外壳的个子老大的路由器，看一下小巧金属外壳的hiwifi还是很养眼的。从来没有接触过路由器固件的相关信息，现在有机会了，了解一下还是很好的，弄个下载机什么的。</p><h2 id="吐槽一下"><a class="header-anchor" href="#吐槽一下">¶ </a>吐槽一下</h2><p>极路由真是太坑爹了，照着小米学，学得不到家。最后真正成了欺骗用户了，虽然自己也是受害者。<br>知乎上有很好的回答，可惜近日已经删除了，不过还是能看出点什么的。</p><ul><li><a href="http://www.zhihu.com/question/21971379" target="_blank" rel="external">如何评价极路由公司 2013 年 11 月发布的「极贰」路由器？</a></li><li><a href="http://www.zhihu.com/question/21996327" target="_blank" rel="external">为什么网络上极路由的负面评价那么多？</a></li></ul><p>虽然被坑了，看习惯了塑料外壳的个子老大的路由器，看一下小巧金属外壳的hiwifi还是很养眼的。<br>从来没有接触过路由器固件的相关信息，现在有机会了，了解一下还是很好的，弄个下载机什么的。</p><a id="more"></a><h2 id="编译hiwifi的openwrt固件"><a class="header-anchor" href="#编译hiwifi的openwrt固件">¶ </a>编译hiwifi的openwrt固件</h2><h3 id="环境准备"><a class="header-anchor" href="#环境准备">¶ </a>环境准备</h3><p>至于环境就没啥好准备的了，自己的电脑编译环境还是很全的。<br>不过，hiwifi的代码是用svn管理的，从没有用过svn，还是先装一个。</p><pre><code>sudo apt-get install subversion git</code></pre><h3 id="获取源码"><a class="header-anchor" href="#获取源码">¶ </a>获取源码</h3><pre><code>svn co https://code.hiwifi.com/svn/hiwifi</code></pre><p>遇到提示输入密码时，直接打回车，然后出来输入用户名的提示，输入极客社区帐号email，再输入密码。</p><h3 id="编译"><a class="header-anchor" href="#编译">¶ </a>编译</h3><pre><code>cd hiwifi/trunk./scripts/feeds update -a./scripts/feeds install -amake package/symlinks </code></pre><h4 id="使用默认的编译选项"><a class="header-anchor" href="#使用默认的编译选项">¶ </a>使用默认的编译选项</h4><pre><code>make HC6361_defconfig </code></pre><h4 id="也可以自定义编译选项-这才是精华所在"><a class="header-anchor" href="#也可以自定义编译选项-这才是精华所在">¶ </a>也可以自定义编译选项（这才是精华所在）</h4><pre><code>make menuconfig</code></pre><p>可以把openssh、python、pythonopenssl、unbound等，都配置进去。</p><p>最后：</p><pre><code>make -j4</code></pre><p>如果出错，要查看详细的编译信息可以使用<code>V=s</code>参数:</p><pre><code>make -j4 V=s</code></pre><p>开始漫长的编译。</p><h3 id="制作成recovery-bin"><a class="header-anchor" href="#制作成recovery-bin">¶ </a>制作成recovery.bin</h3><pre><code>    wget -O rom.bin http://updaterom.ikcd.net/upgrade_file/HC6361-0.775.784s_130802-131633-96d56f0c    dd if=rom.bin of=uboot.bin bs=1k count=128    cat uboot.bin bin/ar71xx/openwrt-ar71xx-generic-tw150v1-squashfs-sysupgrade.bin &gt;recovery.bin</code></pre><p>上面的链接404，暂时的解决方法是跳过wget，手动下载官方的一个<a href="http://bbs.hiwifi.com/thread-7710-1-1.html" target="_blank" rel="external">recovery.bin</a>，重命名为rom.bin然后执行下面的命令提取uboot.bin。</p><h3 id="刷机"><a class="header-anchor" href="#刷机">¶ </a>刷机</h3><ul><li>去这里下载<a href="http://bbs.hiwifi.com/thread-7710-1-1.html" target="_blank" rel="external">官方开源版本固件</a>，解压</li><li>将上一步生成的recovery.bin替换目录中recovery.bin</li><li>用网线将极路由 LAN 口与电脑网口相连</li><li>将电脑网络接口 IP 设置为 192.168.1.88/255.255.255.0</li><li>用尖锐物按住极路由 RESET 不放，给极路由加电</li><li>等待电脑上 tftpd 出现传输 recovery.bin 进度条完成后，松开 RESET</li><li>极路由面板灯进入跑马灯状态，跑完后，系统自动重启，刷机完成</li></ul><h2 id="参考-扩展阅读"><a class="header-anchor" href="#参考-扩展阅读">¶ </a>参考，扩展阅读</h2><ul><li><a href="http://chaopeng.me/blog/2013/10/28/hiwifi.html" target="_blank" rel="external">极路由的正确玩法</a></li><li><a href="http://www.openwrt.org.cn/bbs/forum.php?mod=viewthread&amp;tid=14193" target="_blank" rel="external">OpenWrt安装goagent实例教程</a></li><li><a href="http://blog.csdn.net/conupefox/article/details/8557253" target="_blank" rel="external">Openwrt架设DNS转发器，解决污染问题 </a></li><li><a href="https://code.google.com/p/openwrt-hiwifi/" target="_blank" rel="external">openwrt-hiwifi</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;虽然被坑了，看习惯了塑料外壳的个子老大的路由器，看一下小巧金属外壳的hiwifi还是很养眼的。从来没有接触过路由器固件的相关信息，现在有机会了，了解一下还是很好的，弄个下载机什么的。&lt;/p&gt;
&lt;h2 id=&quot;吐槽一下&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#吐槽一下&quot;&gt;¶ &lt;/a&gt;吐槽一下&lt;/h2&gt;
&lt;p&gt;极路由真是太坑爹了，照着小米学，学得不到家。最后真正成了欺骗用户了，虽然自己也是受害者。&lt;br&gt;
知乎上有很好的回答，可惜近日已经删除了，不过还是能看出点什么的。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.zhihu.com/question/21971379&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;如何评价极路由公司 2013 年 11 月发布的「极贰」路由器？&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.zhihu.com/question/21996327&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;为什么网络上极路由的负面评价那么多？&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;虽然被坑了，看习惯了塑料外壳的个子老大的路由器，看一下小巧金属外壳的hiwifi还是很养眼的。&lt;br&gt;
从来没有接触过路由器固件的相关信息，现在有机会了，了解一下还是很好的，弄个下载机什么的。&lt;/p&gt;
    
    </summary>
    
      <category term="Openwrt" scheme="http://blog.omitol.com/categories/Openwrt/"/>
    
    
      <category term="Hiwifi" scheme="http://blog.omitol.com/tags/Hiwifi/"/>
    
  </entry>
  
  <entry>
    <title>Linux 下 mail 命令的使用</title>
    <link href="http://blog.omitol.com/2013/10/31/linux-send-mail/"/>
    <id>http://blog.omitol.com/2013/10/31/linux-send-mail/</id>
    <published>2013-10-30T16:00:00.000Z</published>
    <updated>2017-10-12T03:15:09.761Z</updated>
    
    <content type="html"><![CDATA[<p>因为服务器上 android 项目的一个编译脚本，要检测编译的状况。要增加一个发送 email 的功能，可以以前没有用过，就研究一下。</p><h2 id="安装"><a class="header-anchor" href="#安装">¶ </a>安装</h2><p>安装 mailutils</p><pre><code>sudo apt-get install mailutils</code></pre><p>因为还要发送附件，需安装</p><pre><code>sudo apt-get install sharutils</code></pre><a id="more"></a><h2 id="发送方式"><a class="header-anchor" href="#发送方式">¶ </a>发送方式</h2><h3 id="一般的发送方式"><a class="header-anchor" href="#一般的发送方式">¶ </a>一般的发送方式</h3><pre><code>mail address@address.com</code></pre><p>编辑抄送对象，邮件主题，邮件正文后，按 Ctrl-D 结束。</p><h3 id="快速发送方式"><a class="header-anchor" href="#快速发送方式">¶ </a>快速发送方式</h3><pre><code>echo “邮件正文” | mail -s &quot;邮件主题&quot; address@address.com</code></pre><h3 id="以文件内容作为邮件正文来发送"><a class="header-anchor" href="#以文件内容作为邮件正文来发送">¶ </a>以文件内容作为邮件正文来发送</h3><pre><code>mail -s &quot;邮件主题&quot; address@address.com &lt; 邮件正文.txt</code></pre><h3 id="发送带附件的邮件"><a class="header-anchor" href="#发送带附件的邮件">¶ </a>发送带附件的邮件</h3><pre><code>uuencode 附件名称 附件显示名称 | mail -s &quot;邮件主题&quot; address@address.com </code></pre><p>例如：</p><pre><code> uuencode test.txt test.txt | mail -s Test address@gmail.com</code></pre><h3 id="以文件内容作为邮件正文和同时发送附件"><a class="header-anchor" href="#以文件内容作为邮件正文和同时发送附件">¶ </a>以文件内容作为邮件正文和同时发送附件</h3><p>没有找到什么便利的方法<br>例：</p><pre><code>uuencode log.tar.gz log.tar.gz &gt; attachment.txtcat info.txt attachment.txt &gt; combined.txtmail -s &quot;服务器编译错误，请查看日志文件&quot; x2280854@gmail.com &lt; combined.txt</code></pre><p>经测试，发送到 gmail 邮箱，邮件正文和附件是可以正确识别的。而发送到 163 的公司邮箱，无法正确识别，而是把整个 combined.txt 当作了正文。</p><h2 id="11-26-更新"><a class="header-anchor" href="#11-26-更新">¶ </a>11.26 更新</h2><h3 id="遇到的一个错误"><a class="header-anchor" href="#遇到的一个错误">¶ </a>遇到的一个错误</h3><p>最近一段时间服务器上的邮件，一直无法成功发送到我的邮箱，今天抽空看了一下。</p><pre><code>/usr/lib/sendmail -bp</code></pre><p>错误日志：</p><blockquote><p>47DA518ADCE6      397 Tue Nov 26 14:40:39  shenduos@Raphael-DeepinLinux<br>(Host or domain name not found. Name service error for <a href="http://name=gmail.com" target="_blank" rel="external">name=gmail.com</a> type=MX: Host not found, try again)<br><a href="mailto:x2280854@gmail.com" target="_blank" rel="external">x2280854@gmail.com</a></p></blockquote><p>最后的问题在：</p><pre><code>/var/spool/postfix/etc/resolv.conf</code></pre><p>编辑 <code>/var/spool/postfix/etc/resolv.conf</code>，文件内容应该和 <code>/etc/resolv.conf</code> 中一样。</p><h2 id="参考"><a class="header-anchor" href="#参考">¶ </a>参考</h2><ul><li><a href="http://blog.csdn.net/c395565746c/article/details/6011731" target="_blank" rel="external">Linux mail命令使用 </a></li><li><a href="http://sunxiaqw.blog.163.com/blog/static/99065438201010182277261/" target="_blank" rel="external">linux下mail命令使用(转)</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;因为服务器上 android 项目的一个编译脚本，要检测编译的状况。要增加一个发送 email 的功能，可以以前没有用过，就研究一下。&lt;/p&gt;
&lt;h2 id=&quot;安装&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#安装&quot;&gt;¶ &lt;/a&gt;安装&lt;/h2&gt;
&lt;p&gt;安装 mailutils&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;sudo apt-get install mailutils
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;因为还要发送附件，需安装&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;sudo apt-get install sharutils
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="Ubuntu" scheme="http://blog.omitol.com/categories/Ubuntu/"/>
    
    
  </entry>
  
  <entry>
    <title>git stash 的使用</title>
    <link href="http://blog.omitol.com/2013/10/22/git-stash/"/>
    <id>http://blog.omitol.com/2013/10/22/git-stash/</id>
    <published>2013-10-21T16:00:00.000Z</published>
    <updated>2017-09-27T13:20:18.000Z</updated>
    
    <content type="html"><![CDATA[<p>对于有时某些未完善的修改，并不想commit时，而又有需求切换分支工作时，这时git stash命令就派上用场了</p><h2 id="搁置修改"><a class="header-anchor" href="#搁置修改">¶ </a>搁置修改</h2><p>有时在分支上有未提交的修改，因为要切到其它分支或要做其它修改测试，因修改未整理，不想提交。这时就可以使用stash命令，例：</p><pre><code>git add .git stash</code></pre><p>这样把未提交的修改暂时搁置，所有文件恢复到未修改之前的，然后就可以进行其它的工作了</p><a id="more"></a><h2 id="恢复搁置的修改"><a class="header-anchor" href="#恢复搁置的修改">¶ </a>恢复搁置的修改</h2><p>恢复之前搁置的修改：</p><pre><code>git stash apply</code></pre><h2 id="git-stash-的其它命令"><a class="header-anchor" href="#git-stash-的其它命令">¶ </a>git stash 的其它命令</h2><h3 id="查看所有之前搁置的修改"><a class="header-anchor" href="#查看所有之前搁置的修改">¶ </a>查看所有之前搁置的修改</h3><pre><code>git stash list</code></pre><h3 id="恢复其中的某个修改"><a class="header-anchor" href="#恢复其中的某个修改">¶ </a>恢复其中的某个修改</h3><pre><code>git stash apply stash@{1} #注意这是找回第二个git stash pop #找回第一个</code></pre><h3 id="删除某个stash"><a class="header-anchor" href="#删除某个stash">¶ </a>删除某个stash</h3><pre><code>git stash drop &lt;id&gt;</code></pre><h3 id="删除所有stash"><a class="header-anchor" href="#删除所有stash">¶ </a>删除所有stash</h3><pre><code>git stash clear</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;对于有时某些未完善的修改，并不想commit时，而又有需求切换分支工作时，这时git stash命令就派上用场了&lt;/p&gt;
&lt;h2 id=&quot;搁置修改&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#搁置修改&quot;&gt;¶ &lt;/a&gt;搁置修改&lt;/h2&gt;
&lt;p&gt;有时在分支上有未提交的修改，因为要切到其它分支或要做其它修改测试，因修改未整理，不想提交。这时就可以使用stash命令，例：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;git add .
git stash
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;这样把未提交的修改暂时搁置，所有文件恢复到未修改之前的，然后就可以进行其它的工作了&lt;/p&gt;
    
    </summary>
    
      <category term="Tips" scheme="http://blog.omitol.com/categories/Tips/"/>
    
    
      <category term="Git" scheme="http://blog.omitol.com/tags/Git/"/>
    
  </entry>
  
</feed>
